<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LP Staking - Admin Panel</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="../assets/logo.png">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/admin-theme.css">
    <link rel="stylesheet" href="../css/theme-toggle.css">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/notifications.css">
    <link rel="stylesheet" href="../css/admin.css">
    <link rel="stylesheet" href="../css/day10-enhancements.css">
    <link rel="stylesheet" href="../css/network-indicator-selector.css">
    <link rel="stylesheet" href="../css/admin-homepage-theme.css">
    
    <!-- Meta Tags -->
    <meta name="description" content="LP Staking Admin Panel - Manage liquidity provider staking contracts">
    <meta name="keywords" content="DeFi, LP Staking, Admin, Blockchain, Ethereum, Polygon">
    <meta name="author" content="LP Staking Protocol">
    
    <!-- Open Graph -->
    <meta property="og:title" content="LP Staking - Admin Panel">
    <meta property="og:description" content="Administrative interface for LP Staking Protocol">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://lpstaking.example.com/admin">
    
    <!-- Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
</head>
<body>
    <!-- Admin Panel Container -->
    <div id="admin-content">
        <!-- Loading state while initializing -->
        <div class="admin-loading">
            <div class="loading-container">
                <div class="loading-spinner"></div>
                <h2>ğŸ” Initializing Admin Panel</h2>
                <p>Verifying administrator privileges...</p>
            </div>
        </div>
    </div>

    <!-- Modal Container (ADDED) -->
    <div id="modal-container" style="display: none;"></div>
    <div id="notification-container" class="notification-container"></div>

    <!-- Error Boundary -->
    <div id="error-boundary" style="display: none;">
        <div class="error-container">
            <h2>âŒ System Error</h2>
            <p id="error-message">An unexpected error occurred.</p>
            <button class="btn btn-primary" onclick="location.reload()">
                Reload Page
            </button>
        </div>
    </div>

    <!-- Version Check System (runs first to ensure fresh cache) -->
    <script src="../js/utils/version-check.js"></script>

    <!-- Scripts -->
    <!-- Configuration (load first) -->
    <script src="../js/config/app-config.js"></script>
    <!-- <script src="../js/config/dev-config.js"></script> -->

    <!-- Core Libraries with fallbacks -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js" onerror="loadEthersFallback()"></script>
    <script>
        function loadEthersFallback() {
            console.log('Primary ethers CDN failed, trying local fallback...');
            const script = document.createElement('script');
            script.src = '../libs/ethers.umd.min.js';
            script.onerror = () => {
                console.error('âŒ All ethers sources failed');
                document.getElementById('error-boundary').style.display = 'flex';
                document.getElementById('error-boundary').innerHTML = `
                    <div class="error-container">
                        <h2>âŒ Critical Error</h2>
                        <p>Ethers.js library failed to load. Please refresh the page or check your internet connection.</p>
                    </div>
                `;
            };
            document.head.appendChild(script);
        }

        // Verify ethers loaded
        window.addEventListener('load', function() {
            setTimeout(() => {
                if (typeof ethers === 'undefined') {
                    console.error('âŒ Ethers.js not loaded after page load');
                    loadEthersFallback();
                } else {
                    console.log('âœ… Ethers.js loaded successfully:', ethers.version);
                }
            }, 1000);
        });
    </script>

    <!-- Theme System (load early to prevent flash) -->
    <script src="../js/core/unified-theme-manager.js"></script>

    <!-- Core System -->
    <script src="../js/debug-logger.js"></script>
    <script src="../js/utils/logger.js"></script>
    <script src="../js/utils/event-manager.js"></script>
    <script src="../js/utils/network-health-check.js"></script>
    <script src="../js/core/error-handler.js"></script>
    
    <!-- Wallet Integration -->
    <script src="../js/wallet/wallet-manager.js"></script>
    <script src="../js/wallet/metamask-connector.js"></script>
    <script src="../js/wallet/walletconnect-connector.js"></script>
    
    <!-- Contract System -->
    <script src="../js/contracts/contract-manager.js"></script>
    
    <!-- Performance Optimization Components -->
    <script src="../js/components/optimized-admin-state.js"></script>
    <script src="../js/components/optimistic-ui-updates.js"></script>
    <script src="../js/components/efficient-dom-updates.js"></script>
    <script src="../js/components/performance-monitor.js"></script>

    <!-- Admin Components -->
    <script src="../js/components/admin-page.js"></script>

    <!-- Master Initializer -->
    <script src="../js/master-initializer.js"></script>

    <script>
        // Debug initialization
        console.log('ğŸ”§ ADMIN DEBUG: Page scripts loading...');

        // Check dependencies periodically
        let checkCount = 0;
        const maxChecks = 20;

        function checkDependencies() {
            checkCount++;
            console.log(`ğŸ”§ ADMIN DEBUG: Dependency check ${checkCount}/${maxChecks}`);
            console.log('ğŸ”§ ADMIN DEBUG: Dependencies status:', {
                ethers: typeof window.ethers !== 'undefined',
                CONFIG: typeof window.CONFIG !== 'undefined',
                contractManager: typeof window.contractManager !== 'undefined',
                adminPage: typeof window.adminPage !== 'undefined'
            });

            if (typeof window.ethers !== 'undefined' &&
                typeof window.CONFIG !== 'undefined' &&
                typeof window.ContractManager !== 'undefined') {

                // Try to initialize ContractManager if it doesn't exist
                if (typeof window.contractManager === 'undefined') {
                    console.log('ğŸ”§ ADMIN DEBUG: Initializing ContractManager...');
                    try {
                        window.contractManager = new ContractManager();
                        console.log('âœ… ADMIN DEBUG: ContractManager created');
                    } catch (error) {
                        console.error('âŒ ADMIN DEBUG: Failed to create ContractManager:', error);
                        console.error('âŒ ADMIN DEBUG: Error details:', error.message);
                        console.error('âŒ ADMIN DEBUG: Error stack:', error.stack);
                    }
                }

                if (typeof window.contractManager !== 'undefined') {
                    console.log('âœ… ADMIN DEBUG: All dependencies loaded!');
                    return true;
                }
            } else {
                // Enhanced debugging for missing dependencies
                console.log('ğŸ” ADMIN DEBUG: Dependency check status:');
                console.log('  - ethers:', typeof window.ethers !== 'undefined' ? 'âœ…' : 'âŒ');
                console.log('  - CONFIG:', typeof window.CONFIG !== 'undefined' ? 'âœ…' : 'âŒ');
                console.log('  - ContractManager class:', typeof window.ContractManager !== 'undefined' ? 'âœ…' : 'âŒ');
            }

            if (checkCount < maxChecks) {
                setTimeout(checkDependencies, 500);
            } else {
                console.error('âŒ ADMIN DEBUG: Dependencies failed to load after 10 seconds');
            }
            return false;
        }

        // Start checking after a short delay
        setTimeout(checkDependencies, 500);

        // Prevent duplicate script loading and initialization
        if (window.adminPanelLoaded) {
            console.log('âš ï¸ Admin panel already loaded, skipping initialization');
        } else {
            window.adminPanelLoaded = true;
            console.log('ğŸ” Admin panel scripts loading...');
        }

        // Global error handler
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            showErrorBoundary(event.error.message);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            showErrorBoundary(event.reason.message || 'Promise rejection');
        });

        function showErrorBoundary(message) {
            document.getElementById('admin-content').style.display = 'none';
            document.getElementById('error-boundary').style.display = 'flex';
            document.getElementById('error-message').textContent = message;
        }

        // Admin Panel Initialization
        let adminPage = null;

        async function initializeAdminPanel() {
            try {
                console.log('ğŸš€ Starting Admin Panel initialization...');

                // Debug: Check what's available
                console.log('ğŸ” System check:');
                console.log('  - ethers:', !!window.ethers);
                console.log('  - WalletManager class:', !!window.WalletManager);
                console.log('  - walletManager instance:', !!window.walletManager);
                console.log('  - masterInitializer:', !!window.masterInitializer);
                console.log('  - AdminPage class:', !!window.AdminPage);

                // ENHANCED: More flexible initialization with timeout
                try {
                    if (!window.masterInitializer) {
                        console.log('â³ Waiting for master initializer...');
                        await waitForMasterInitializer(15000); // Shorter timeout
                    }

                    // Initialize master system
                    if (window.masterInitializer && !window.masterInitializer.isInitialized) {
                        console.log('ğŸ”§ Initializing master system...');
                        await window.masterInitializer.init();
                    }
                } catch (initError) {
                    console.warn('âš ï¸ Master initialization failed, proceeding with basic setup:', initError.message);

                    // Basic fallback initialization
                    if (!window.contractManager && window.ContractManager) {
                        console.log('ğŸ”— Creating contract manager directly...');
                        window.contractManager = new ContractManager();
                        await window.contractManager.init();
                    }
                }

                // Debug: Check wallet manager after initialization
                console.log('ğŸ” Post-init check:');
                console.log('  - walletManager:', !!window.walletManager);
                if (window.walletManager) {
                    console.log('  - connectWallet method:', typeof window.walletManager.connectWallet);
                    console.log('  - connectMetaMask method:', typeof window.walletManager.connectMetaMask);
                    console.log('  - isConnected method:', typeof window.walletManager.isConnected);
                }

                // Check if AdminPage is available
                if (typeof AdminPage === 'undefined') {
                    throw new Error('AdminPage class not loaded. Check if admin-page.js is loading correctly.');
                }

                // Create admin page instance
                console.log('ğŸ” Creating admin page...');
                adminPage = new AdminPage();

                // Make globally accessible
                window.adminPage = adminPage;

                console.log('âœ… Admin Panel initialization complete');

            } catch (error) {
                console.error('âŒ Admin Panel initialization failed:', error);
                showErrorBoundary(`Initialization failed: ${error.message}`);
            }
        }

        function waitForMasterInitializer(timeout = 30000) {
            return new Promise((resolve, reject) => {
                const startTime = Date.now();
                
                const checkInitializer = () => {
                    if (window.masterInitializer) {
                        resolve();
                    } else if (Date.now() - startTime > timeout) {
                        reject(new Error('Master initializer timeout'));
                    } else {
                        setTimeout(checkInitializer, 100);
                    }
                };
                
                checkInitializer();
            });
        }

        // Connect wallet function for admin access (CORS-free approach)
        async function connectWallet() {
            try {
                console.log('ğŸ”— Attempting wallet connection...');

                // Direct MetaMask connection (bypasses wallet manager issues)
                if (!window.ethereum) {
                    throw new Error('MetaMask not installed. Please install MetaMask to continue.');
                }

                console.log('ğŸ¦Š Connecting directly to MetaMask...');

                // Request account access
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                if (!accounts || accounts.length === 0) {
                    throw new Error('No accounts found. Please unlock MetaMask.');
                }

                // Create provider and signer
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const signer = provider.getSigner();
                const address = await signer.getAddress();
                const network = await provider.getNetwork();

                console.log('âœ… Wallet connected successfully');
                console.log('ğŸ“ Address:', address);
                console.log('ğŸŒ Network:', network.chainId);

                // Store connection info globally
                window.walletConnection = {
                    provider,
                    signer,
                    address,
                    network,
                    isConnected: true
                };

                // Update wallet manager if available
                if (window.walletManager) {
                    window.walletManager.provider = provider;
                    window.walletManager.signer = signer;
                    window.walletManager.address = address;
                    window.walletManager.chainId = network.chainId;
                    console.log('ğŸ”„ Updated wallet manager with connection info');
                }

                // Wait a moment for state to update
                await new Promise(resolve => setTimeout(resolve, 500));

                // Reinitialize admin panel after wallet connection
                if (adminPage) {
                    console.log('ğŸ”„ Reinitializing admin panel...');
                    await adminPage.init();
                } else {
                    console.log('âš ï¸ Admin page not available, reloading...');
                    location.reload();
                }

            } catch (error) {
                console.error('âŒ Wallet connection failed:', error);

                // Show user-friendly error message
                let errorMessage;
                if (error.message.includes('User rejected') || error.message.includes('User denied')) {
                    errorMessage = 'Wallet connection was cancelled by user';
                } else if (error.message.includes('not installed')) {
                    errorMessage = 'MetaMask not installed. Please install MetaMask extension.';
                } else if (error.message.includes('No accounts')) {
                    errorMessage = 'Please unlock MetaMask and try again.';
                } else {
                    errorMessage = `Wallet connection failed: ${error.message}`;
                }

                alert(errorMessage);
            }
        }

        // Auto-initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ“„ DOM loaded, waiting for system initialization...');
            // Allow master initializer microtasks to complete
            setTimeout(() => {
                console.log('ğŸ” Starting admin panel initialization...');

                // Check if all required classes are loaded
                const requiredClasses = ['AdminPage', 'ContractManager', 'WalletManager'];
                const missingClasses = requiredClasses.filter(className => typeof window[className] === 'undefined');

                if (missingClasses.length > 0) {
                    console.error('âŒ Missing required classes:', missingClasses);

                    // Check if scripts are still loading
                    const scripts = document.querySelectorAll('script[src*="admin-page.js"], script[src*="contract-manager.js"], script[src*="wallet-manager.js"]');
                    console.log('ğŸ“œ Script elements found:', scripts.length);

                    // Try a few more times with increasing delays
                    let retryCount = parseInt(sessionStorage.getItem('adminInitRetryCount') || '0');
                    if (retryCount < 3) {
                        sessionStorage.setItem('adminInitRetryCount', (retryCount + 1).toString());
                        console.log(`ğŸ”„ Retry attempt ${retryCount + 1}/3 in ${(retryCount + 1) * 2} seconds...`);
                        setTimeout(initializeAdminPanel, (retryCount + 1) * 2000);
                    } else {
                        console.error('âŒ Max retries reached. Script loading failed.');
                        showErrorBoundary('Failed to load required scripts. Please refresh the page.');
                        sessionStorage.removeItem('adminInitRetryCount');
                    }
                } else {
                    console.log('âœ… All required classes loaded');
                    sessionStorage.removeItem('adminInitRetryCount');
                    initializeAdminPanel();
                }
            }, 0); // Kick off on next tick
        });

        // Z-index debugging function
        window.debugZIndex = function() {
            console.log('ğŸ” Z-INDEX DEBUG: Checking all elements with high z-index...');

            const allElements = document.querySelectorAll('*');
            const highZElements = [];

            allElements.forEach(el => {
                const zIndex = window.getComputedStyle(el).zIndex;
                if (zIndex !== 'auto' && parseInt(zIndex) > 100) {
                    highZElements.push({
                        element: el.tagName + (el.id ? '#' + el.id : '') + (el.className ? '.' + el.className.split(' ').join('.') : ''),
                        zIndex: zIndex,
                        position: window.getComputedStyle(el).position
                    });
                }
            });

            console.log('ğŸ” Elements with high z-index:', highZElements);

            // Check modal container specifically
            const modalContainer = document.getElementById('modal-container');
            if (modalContainer) {
                const style = window.getComputedStyle(modalContainer);
                console.log('ğŸ” Modal container styles:', {
                    display: style.display,
                    zIndex: style.zIndex,
                    position: style.position,
                    opacity: style.opacity,
                    visibility: style.visibility
                });
            }
        };

        // Modal button visibility test
        window.testModalButtons = function() {
            console.log('ğŸ” TESTING: Modal button visibility...');

            const modalContainer = document.getElementById('modal-container');
            if (!modalContainer) {
                console.error('âŒ Modal container not found');
                return;
            }

            const modalFooter = modalContainer.querySelector('.modal-footer');
            const buttons = modalContainer.querySelectorAll('.modal-footer button');

            console.log('ğŸ” Modal footer found:', !!modalFooter);
            console.log('ğŸ” Buttons found:', buttons.length);

            if (modalFooter) {
                const footerStyle = window.getComputedStyle(modalFooter);
                console.log('ğŸ” Modal footer styles:', {
                    display: footerStyle.display,
                    visibility: footerStyle.visibility,
                    opacity: footerStyle.opacity,
                    height: footerStyle.height,
                    position: footerStyle.position
                });
            }

            buttons.forEach((btn, index) => {
                const btnStyle = window.getComputedStyle(btn);
                console.log(`ğŸ” Button ${index + 1}:`, {
                    text: btn.textContent.trim(),
                    display: btnStyle.display,
                    visibility: btnStyle.visibility,
                    opacity: btnStyle.opacity
                });
            });
        };

        // Test all admin modals
        window.testAllModals = function() {
            console.log('ğŸ§ª TESTING: All admin modals...');

            // First check if admin interface is loaded
            const adminContainer = document.querySelector('.admin-grid-main');
            if (!adminContainer) {
                console.log('âŒ Admin interface not loaded yet. Wait a moment and try again.');
                return;
            }

            const modalTypes = [
                'hourly-rate',
                'add-pair',
                'remove-pair',
                'update-weights',
                'change-signer',
                'withdraw-rewards'
            ];

            // Check all buttons exist first
            console.log('ğŸ” Checking button availability...');
            modalTypes.forEach(type => {
                const button = document.querySelector(`[data-modal="${type}"]`);
                console.log(`ğŸ” Button [data-modal="${type}"]:`, button ? 'âœ… Found' : 'âŒ Not found');
            });

            modalTypes.forEach((type, index) => {
                setTimeout(() => {
                    console.log(`ğŸ§ª Testing modal: ${type}`);

                    // Simulate button click
                    const button = document.querySelector(`[data-modal="${type}"]`);
                    if (button) {
                        console.log(`âœ… Clicking button for: ${type}`);
                        button.click();

                        setTimeout(() => {
                            const modal = document.getElementById('modal-container');
                            const buttons = modal ? modal.querySelectorAll('.modal-footer button') : [];
                            console.log(`âœ… ${type} modal: ${buttons.length} buttons found`);

                            // Log button details
                            buttons.forEach((btn, btnIndex) => {
                                console.log(`  Button ${btnIndex + 1}: "${btn.textContent.trim()}"`);
                            });

                            // Close modal
                            if (modal) {
                                modal.style.display = 'none';
                                modal.innerHTML = '';
                            }
                        }, 800);
                    } else {
                        console.log(`âŒ Button not found for: ${type}`);
                        // Try alternative selector
                        const altButton = document.querySelector(`.proposal-btn:contains("${type}")`);
                        console.log(`ğŸ” Alternative search result:`, altButton ? 'âœ… Found' : 'âŒ Not found');
                    }
                }, index * 1500);
            });
        };

        // Test individual modal
        window.testModal = function(modalType) {
            console.log(`ğŸ§ª Testing individual modal: ${modalType}`);

            const button = document.querySelector(`[data-modal="${modalType}"]`);
            if (button) {
                console.log(`âœ… Found button for: ${modalType}`);
                button.click();

                setTimeout(() => {
                    const modal = document.getElementById('modal-container');
                    const buttons = modal ? modal.querySelectorAll('.modal-footer button') : [];
                    const footer = modal ? modal.querySelector('.modal-footer') : null;

                    console.log(`ğŸ“Š Modal Results for ${modalType}:`);
                    console.log(`  - Modal container: ${modal ? 'âœ… Found' : 'âŒ Not found'}`);
                    console.log(`  - Modal footer: ${footer ? 'âœ… Found' : 'âŒ Not found'}`);
                    console.log(`  - Footer buttons: ${buttons.length}`);

                    if (footer) {
                        const footerStyle = window.getComputedStyle(footer);
                        console.log(`  - Footer display: ${footerStyle.display}`);
                        console.log(`  - Footer visibility: ${footerStyle.visibility}`);
                        console.log(`  - Footer opacity: ${footerStyle.opacity}`);
                    }

                    buttons.forEach((btn, index) => {
                        const btnStyle = window.getComputedStyle(btn);
                        console.log(`  - Button ${index + 1}: "${btn.textContent.trim()}" (display: ${btnStyle.display}, visibility: ${btnStyle.visibility})`);
                    });
                }, 1000);
            } else {
                console.log(`âŒ Button not found for: ${modalType}`);
                console.log('Available buttons:');
                document.querySelectorAll('.proposal-btn').forEach(btn => {
                    console.log(`  - ${btn.textContent.trim()} [data-modal="${btn.dataset.modal}"]`);
                });
            }
        };

        // Test cancel buttons
        window.testCancelButtons = function() {
            console.log('ğŸ§ª Testing cancel button functionality...');

            const modalTypes = ['hourly-rate', 'add-pair', 'remove-pair', 'update-weights', 'change-signer', 'withdraw-rewards'];

            modalTypes.forEach((type, index) => {
                setTimeout(() => {
                    console.log(`ğŸ§ª Testing cancel for: ${type}`);

                    // Open modal
                    const button = document.querySelector(`[data-modal="${type}"]`);
                    if (button) {
                        button.click();

                        setTimeout(() => {
                            // Find and test cancel button
                            const modal = document.getElementById('modal-container');
                            const cancelBtn = modal ? modal.querySelector('.btn-secondary, .modal-cancel') : null;

                            if (cancelBtn) {
                                console.log(`âœ… Cancel button found for ${type}:`, cancelBtn.textContent.trim());
                                console.log(`  - Classes: ${cancelBtn.className}`);
                                console.log(`  - OnClick: ${cancelBtn.getAttribute('onclick')}`);

                                // Test click
                                cancelBtn.click();

                                setTimeout(() => {
                                    const modalAfter = document.getElementById('modal-container');
                                    const isHidden = !modalAfter || modalAfter.style.display === 'none' || modalAfter.innerHTML === '';
                                    console.log(`  - Cancel worked: ${isHidden ? 'âœ… YES' : 'âŒ NO'}`);
                                }, 200);
                            } else {
                                console.log(`âŒ Cancel button not found for: ${type}`);
                            }
                        }, 500);
                    }
                }, index * 2000);
            });
        };


        // Debug form validation directly
        window.debugFormValidation = function() {
            console.log('ğŸ”§ DEBUG: Testing form validation...');

            // Check if modal is open
            const modal = document.getElementById('modal-container');
            console.log('Modal container:', modal);
            console.log('Modal display:', modal ? modal.style.display : 'N/A');
            console.log('Modal innerHTML length:', modal ? modal.innerHTML.length : 0);

            // Check for forms
            const allForms = document.querySelectorAll('form');
            console.log('All forms in document:', allForms.length);
            allForms.forEach((form, index) => {
                console.log(`Form ${index + 1}:`, {
                    id: form.id,
                    classes: form.className,
                    parent: form.parentElement?.tagName,
                    visible: form.offsetParent !== null
                });
            });

            // Try to find add-pair-form specifically
            const addPairForm = document.getElementById('add-pair-form');
            console.log('add-pair-form found:', !!addPairForm);
            if (addPairForm) {
                console.log('Form details:', {
                    id: addPairForm.id,
                    visible: addPairForm.offsetParent !== null,
                    inputs: addPairForm.querySelectorAll('input, select, textarea').length
                });
            }
        };

        // Test form submission directly
        window.testFormSubmission = function() {
            console.log('ğŸ”§ Testing form submission...');

            // Open add pair modal first
            const addPairBtn = document.querySelector('[data-modal="add-pair"]');
            if (addPairBtn) {
                console.log('Opening add pair modal...');
                addPairBtn.click();

                setTimeout(() => {
                    debugFormValidation();

                    // Try to submit form
                    const form = document.getElementById('add-pair-form');
                    if (form) {
                        console.log('Attempting to submit form...');
                        const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                        form.dispatchEvent(submitEvent);
                    }
                }, 1000);
            }
        };

        // Test contract function directly
        window.testContractFunction = async function() {
            console.log('ğŸ”§ Testing contract function directly...');

            try {
                // Get contract manager
                const contractManager = window.contractManager;
                if (!contractManager) {
                    console.error('âŒ Contract manager not available');
                    return;
                }

                console.log('ğŸ”§ Contract manager found, testing proposeAddPair...');

                // Test the proposeAddPair function
                const result = await contractManager.proposeAddPair(
                    '0x1234567890123456789012345678901234567890',
                    'TEST/USDC',
                    'Uniswap V3',
                    100
                );

                console.log('âœ… Contract function result:', result);

                if (result.success) {
                    console.log('ğŸ‰ Mock transaction successful!');
                    console.log('ğŸ“‹ Transaction hash:', result.transactionHash);
                } else {
                    console.log('âŒ Contract function failed:', result.error);
                }

            } catch (error) {
                console.error('âŒ Test failed:', error);
            }
        };

        // Test ADD PAIR functionality
        window.testAddPair = async function() {
            console.log('ğŸ§ª Testing ADD PAIR functionality...');

            if (!window.adminPage) {
                console.error('âŒ AdminPage not available');
                return;
            }

            try {
                // Get contract manager
                const contractManager = window.contractManager;
                if (!contractManager) {
                    console.error('âŒ Contract manager not available');
                    return;
                }

                console.log('ğŸ”§ Contract manager found, testing proposeAddPair...');

                // Test the proposeAddPair function
                const result = await contractManager.proposeAddPair(
                    '0x1234567890123456789012345678901234567890',
                    'TEST/USDC',
                    'Uniswap V3',
                    100
                );

                console.log('âœ… Contract function result:', result);

                if (result.success) {
                    console.log('ğŸ‰ Proposal creation successful!');
                    console.log('ğŸ“‹ Transaction hash:', result.transactionHash);

                    // Refresh the admin panel to show new proposal
                    await window.adminPage.refreshData();
                    console.log('âœ… Admin panel refreshed');
                } else {
                    console.log('âŒ Contract function failed:', result.error);
                }

            } catch (error) {
                console.error('âŒ Test failed:', error);
            }
        };

        // Test real contract governance functions
        window.testRealContract = async function() {
            console.log('ğŸ§ª Testing REAL CONTRACT governance functions...');

            try {
                const contractManager = window.contractManager;
                if (!contractManager) {
                    console.error('âŒ Contract manager not available');
                    return;
                }

                console.log('ğŸ”§ Testing contract functions...');

                // Test 1: Check actionCounter
                try {
                    const actionCounter = await contractManager.stakingContract.actionCounter();
                    console.log('âœ… actionCounter:', actionCounter.toString());
                } catch (error) {
                    console.error('âŒ actionCounter failed:', error.message);
                }

                // Test 2: Check REQUIRED_APPROVALS
                try {
                    const requiredApprovals = await contractManager.stakingContract.REQUIRED_APPROVALS();
                    console.log('âœ… REQUIRED_APPROVALS:', requiredApprovals.toString());
                } catch (error) {
                    console.error('âŒ REQUIRED_APPROVALS failed:', error.message);
                }

                // Test 3: Check if approveAction function exists
                try {
                    const hasApproveAction = typeof contractManager.stakingContract.approveAction === 'function';
                    console.log('âœ… approveAction function exists:', hasApproveAction);
                } catch (error) {
                    console.error('âŒ approveAction check failed:', error.message);
                }

                // Test 4: Check if rejectAction function exists
                try {
                    const hasRejectAction = typeof contractManager.stakingContract.rejectAction === 'function';
                    console.log('âœ… rejectAction function exists:', hasRejectAction);
                } catch (error) {
                    console.error('âŒ rejectAction check failed:', error.message);
                }

                // Test 5: Check if proposeAddPair function exists
                try {
                    const hasProposeAddPair = typeof contractManager.stakingContract.proposeAddPair === 'function';
                    console.log('âœ… proposeAddPair function exists:', hasProposeAddPair);
                } catch (error) {
                    console.error('âŒ proposeAddPair check failed:', error.message);
                }

                console.log('ğŸ‰ Real contract test completed!');

            } catch (error) {
                console.error('âŒ Real contract test failed:', error);
            }
        };

        // Test wallet and signer status
        window.testWalletSigner = async function() {
            console.log('ğŸ§ª Testing WALLET AND SIGNER status...');

            try {
                // Test 1: Check wallet manager
                if (window.walletManager) {
                    console.log('âœ… Wallet manager exists');
                    console.log('ğŸ” Wallet connected:', window.walletManager.isConnected());
                    console.log('ğŸ” Wallet address:', window.walletManager.getAddress());
                    console.log('ğŸ” Wallet type:', window.walletManager.getWalletType());
                    console.log('ğŸ” Chain ID:', window.walletManager.getChainId());
                } else {
                    console.error('âŒ Wallet manager not found');
                }

                // Test 2: Check contract manager
                if (window.contractManager) {
                    console.log('âœ… Contract manager exists');
                    console.log('ğŸ” Contract manager ready:', window.contractManager.isReady());
                    console.log('ğŸ” Has provider:', !!window.contractManager.provider);
                    console.log('ğŸ” Has signer:', !!window.contractManager.signer);

                    // Test signer
                    if (window.contractManager.signer) {
                        try {
                            const signerAddress = await window.contractManager.signer.getAddress();
                            console.log('âœ… Signer address:', signerAddress);
                        } catch (error) {
                            console.error('âŒ Signer address failed:', error.message);
                        }
                    } else {
                        console.warn('âš ï¸ No signer available');
                    }
                } else {
                    console.error('âŒ Contract manager not found');
                }

                // Test 3: Check MetaMask
                if (window.ethereum) {
                    console.log('âœ… MetaMask available');
                    try {
                        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                        console.log('ğŸ” MetaMask accounts:', accounts);
                    } catch (error) {
                        console.error('âŒ MetaMask accounts failed:', error.message);
                    }
                } else {
                    console.error('âŒ MetaMask not available');
                }

                console.log('ğŸ‰ Wallet/Signer test completed!');

            } catch (error) {
                console.error('âŒ Wallet/Signer test failed:', error);
            }
        };

        // Force fix signer issue
        window.fixSigner = async function() {
            console.log('ğŸ”§ FIXING SIGNER ISSUE...');

            try {
                if (!window.contractManager) {
                    console.error('âŒ Contract manager not found');
                    return;
                }

                // Force get signer from MetaMask
                if (window.ethereum) {
                    console.log('ğŸ”§ Getting signer from MetaMask...');
                    const provider = new ethers.providers.Web3Provider(window.ethereum);
                    const signer = provider.getSigner();

                    // Verify signer works
                    const address = await signer.getAddress();
                    console.log('âœ… Signer address:', address);

                    // Update contract manager
                    window.contractManager.provider = provider;
                    window.contractManager.signer = signer;

                    // Reinitialize contracts with signer
                    await window.contractManager.initializeContracts();
                    console.log('âœ… Contract manager updated with signer');

                    // Test signer again
                    await testWalletSigner();

                } else {
                    console.error('âŒ MetaMask not available');
                }

            } catch (error) {
                console.error('âŒ Fix signer failed:', error);
            }
        };

        // Complete system fix
        window.fixEverything = async function() {
            console.log('ğŸ”§ FIXING ALL SYSTEM ISSUES...');

            try {
                // Step 1: Fix signer
                console.log('ğŸ”§ Step 1: Fixing signer...');
                await fixSigner();

                // Step 2: Test contract functions
                console.log('ğŸ”§ Step 2: Testing contract functions...');
                await testRealContract();

                // Step 3: Refresh admin panel
                console.log('ğŸ”§ Step 3: Refreshing admin panel...');
                if (window.adminPage) {
                    await window.adminPage.refreshData();
                }

                console.log('ğŸ‰ SYSTEM FIX COMPLETED!');
                console.log('âœ… Try the ADD PAIR button now');

            } catch (error) {
                console.error('âŒ System fix failed:', error);
            }
        };

        // Test contract signer integration
        window.testContractSigner = async function() {
            console.log('ğŸ§ª Testing CONTRACT SIGNER integration...');

            try {
                const contractManager = window.contractManager;
                if (!contractManager) {
                    console.error('âŒ Contract manager not found');
                    return;
                }

                // Test 1: Check if contracts have signer
                console.log('ğŸ” Staking contract signer:', !!contractManager.stakingContract?.signer);
                console.log('ğŸ” Reward token contract signer:', !!contractManager.rewardTokenContract?.signer);

                // Test 2: Force ensure signer
                console.log('ğŸ”§ Ensuring signer...');
                await contractManager.ensureSigner();

                // Test 3: Check contracts again
                console.log('ğŸ” After ensureSigner - Staking contract signer:', !!contractManager.stakingContract?.signer);
                console.log('ğŸ” After ensureSigner - Reward token contract signer:', !!contractManager.rewardTokenContract?.signer);

                // Test 4: Try to get signer address from contract
                if (contractManager.stakingContract?.signer) {
                    try {
                        const signerAddress = await contractManager.stakingContract.signer.getAddress();
                        console.log('âœ… Contract signer address:', signerAddress);
                    } catch (error) {
                        console.error('âŒ Contract signer address failed:', error.message);
                    }
                }

                console.log('ğŸ‰ Contract signer test completed!');

            } catch (error) {
                console.error('âŒ Contract signer test failed:', error);
            }
        };

        // Ultimate fix for all signer issues
        window.ultimateSignerFix = async function() {
            console.log('ğŸ”§ ULTIMATE SIGNER FIX - Fixing all issues...');

            try {
                const contractManager = window.contractManager;
                if (!contractManager) {
                    console.error('âŒ Contract manager not found');
                    return;
                }

                // Step 1: Force get signer from MetaMask
                console.log('ğŸ”§ Step 1: Getting signer from MetaMask...');
                if (!window.ethereum) {
                    console.error('âŒ MetaMask not available');
                    return;
                }

                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const signer = provider.getSigner();

                // Verify signer works
                const address = await signer.getAddress();
                console.log('âœ… Signer address:', address);

                // Step 2: Update contract manager
                console.log('ğŸ”§ Step 2: Updating contract manager...');
                contractManager.provider = provider;
                contractManager.signer = signer;

                // Step 3: Recreate all contracts with signer
                console.log('ğŸ”§ Step 3: Recreating contracts with signer...');
                await contractManager.initializeContracts();

                // Step 4: Verify contracts have signer
                console.log('ğŸ”§ Step 4: Verifying contracts...');
                console.log('âœ… Staking contract has signer:', !!contractManager.stakingContract?.signer);
                console.log('âœ… Reward token contract has signer:', !!contractManager.rewardTokenContract?.signer);

                // Step 5: Test a simple contract call
                console.log('ğŸ”§ Step 5: Testing contract call...');
                try {
                    const rewardToken = await contractManager.stakingContract.rewardToken();
                    console.log('âœ… Contract call successful, reward token:', rewardToken);
                } catch (error) {
                    console.log('âš ï¸ Contract call failed (might be network issue):', error.message);
                }

                console.log('ğŸ‰ ULTIMATE SIGNER FIX COMPLETED!');
                console.log('âœ… Try the ADD PAIR or HOURLY RATE buttons now');

            } catch (error) {
                console.error('âŒ Ultimate signer fix failed:', error);
            }
        };

        // Test proposal creation with error handling
        window.testProposalCreation = async function() {
            console.log('ğŸ§ª Testing PROPOSAL CREATION with error handling...');

            try {
                const contractManager = window.contractManager;
                if (!contractManager) {
                    console.error('âŒ Contract manager not found');
                    return;
                }

                // Test 1: Test add pair proposal
                console.log('ğŸ”§ Testing add pair proposal...');
                const addPairResult = await contractManager.proposeAddPair(
                    '0x1234567890123456789012345678901234567890',
                    'TEST/USDC',
                    'Uniswap V3',
                    100,
                    'Test proposal'
                );

                console.log('âœ… Add pair result:', addPairResult);

                if (addPairResult.success) {
                    if (addPairResult.isDemo) {
                        console.log('âœ… Demo proposal created successfully');
                        console.log('   - Message:', addPairResult.message);
                        console.log('   - Transaction Hash:', addPairResult.transactionHash);
                    } else {
                        console.log('âœ… Real proposal created successfully');
                        console.log('   - Transaction Hash:', addPairResult.transactionHash);
                    }
                } else {
                    console.error('âŒ Add pair proposal failed:', addPairResult.error);
                }

                // Test 2: Test hourly rate proposal
                console.log('ğŸ”§ Testing hourly rate proposal...');
                const hourlyRateResult = await contractManager.proposeSetHourlyRewardRate(0.1);

                console.log('âœ… Hourly rate result:', hourlyRateResult);

                if (hourlyRateResult.success) {
                    if (hourlyRateResult.isDemo) {
                        console.log('âœ… Demo hourly rate proposal created successfully');
                        console.log('   - Message:', hourlyRateResult.message);
                        console.log('   - Transaction Hash:', hourlyRateResult.transactionHash);
                    } else {
                        console.log('âœ… Real hourly rate proposal created successfully');
                        console.log('   - Transaction Hash:', hourlyRateResult.transactionHash);
                    }
                } else {
                    console.error('âŒ Hourly rate proposal failed:', hourlyRateResult.error);
                }

                console.log('ğŸ‰ Proposal creation test completed!');

            } catch (error) {
                console.error('âŒ Proposal creation test failed:', error);
            }
        };

        // Complete system test
        window.completeSystemTest = async function() {
            console.log('ğŸ§ª COMPLETE SYSTEM TEST - Testing everything...');

            try {
                // Step 1: Test wallet and signer
                console.log('ğŸ”§ Step 1: Testing wallet and signer...');
                await testWalletSigner();

                // Step 2: Test contract signer integration
                console.log('ğŸ”§ Step 2: Testing contract signer integration...');
                await testContractSigner();

                // Step 3: Test proposal creation
                console.log('ğŸ”§ Step 3: Testing proposal creation...');
                await testProposalCreation();

                // Step 4: Test forms
                console.log('ğŸ”§ Step 4: Forms should now work - try the ADD PAIR and HOURLY RATE buttons!');
                console.log('âœ… COMPLETE SYSTEM TEST PASSED!');
                console.log('ğŸ‰ The system is ready for demo use!');

            } catch (error) {
                console.error('âŒ Complete system test failed:', error);
            }
        };

        // Test the actual forms like React version
        window.testFormsLikeReact = async function() {
            console.log('ğŸ§ª Testing forms with React-like patterns...');

            try {
                // Test 1: Test hourly rate form
                console.log('ğŸ”§ Testing hourly rate form...');

                // Fill form fields
                const rateInput = document.getElementById('new-rate');

                if (rateInput) {
                    rateInput.value = '0.5';

                    // Simulate form submission
                    const result = await window.adminPage.submitHourlyRateProposal({preventDefault: () => {}});
                    console.log('âœ… Hourly rate form test result:', result);
                } else {
                    console.log('âš ï¸ Hourly rate form fields not found - open the modal first');
                }

                // Test 2: Test add pair form
                console.log('ğŸ”§ Testing add pair form...');

                const pairAddressInput = document.getElementById('pair-address');
                const pairNameInput = document.getElementById('pair-name');
                const pairPlatformInput = document.getElementById('pair-platform');
                const pairWeightInput = document.getElementById('pair-weight');
                if (pairAddressInput && pairNameInput && pairPlatformInput && pairWeightInput) {
                    pairAddressInput.value = '0x1234567890123456789012345678901234567890';
                    pairNameInput.value = 'TEST/USDC';
                    pairPlatformInput.value = 'Uniswap V3';
                    pairWeightInput.value = '100';

                    // Simulate form submission
                    const result = await window.adminPage.submitAddPairProposal({preventDefault: () => {}});
                    console.log('âœ… Add pair form test result:', result);
                } else {
                    console.log('âš ï¸ Add pair form fields not found - open the modal first');
                }

                console.log('ğŸ‰ Form testing completed!');
                console.log('âœ… Both forms should now work without errors');

            } catch (error) {
                console.error('âŒ Form testing failed:', error);
            }
        };

        // Test proposal loading specifically
        window.testProposalLoading = async function() {
            console.log('ğŸ§ª Testing proposal loading like React version...');

            try {
                const contractManager = await window.adminPage.ensureContractReady();

                // Test 1: Get action counter
                console.log('ğŸ”§ Testing getActionCounter...');
                const actionCounter = await contractManager.getActionCounter();
                console.log('âœ… Action counter:', actionCounter);

                // Test 2: Try to get actions (like React version)
                console.log('ğŸ”§ Testing getAction calls...');
                for (let i = actionCounter; i >= Math.max(1, actionCounter - 5); i--) {
                    console.log(`ğŸ”§ Testing getAction(${i})...`);
                    const action = await contractManager.getAction(i);
                    if (action) {
                        console.log(`âœ… Action ${i}:`, {
                            actionType: action.actionType,
                            executed: action.executed,
                            approvals: action.approvals
                        });
                    } else {
                        console.log(`âš ï¸ Action ${i}: null (gracefully handled)`);
                    }
                }

                // Test 3: Load proposals through admin page
                console.log('ğŸ”§ Testing loadProposals...');
                const proposals = await window.adminPage.loadProposals();
                console.log('âœ… Loaded proposals:', proposals.length);
                proposals.forEach(p => {
                    console.log(`  - Proposal ${p.id}: ${p.actionType} (${p.approvals}/${p.requiredApprovals} approvals)`);
                });

                // Test 4: Check if proposals show in UI
                console.log('ğŸ”§ Checking UI display...');
                const proposalRows = document.querySelectorAll('.proposal-row');
                console.log(`âœ… Found ${proposalRows.length} proposal rows in UI`);

                console.log('ğŸ‰ Proposal loading test completed!');

            } catch (error) {
                console.error('âŒ Proposal loading test failed:', error);
            }
        };

        // Test RPC health and fallback system
        window.testRpcHealthAndFallbacks = async function() {
            console.log('ğŸ§ª Testing RPC health and fallback system...');

            try {
                const contractManager = await window.adminPage.ensureContractReady();

                // Test 1: Check RPC health
                console.log('ğŸ”§ Testing RPC health check...');
                const isRpcDown = await window.adminPage.checkRpcHealth(contractManager);
                console.log('âœ… RPC health check result:', isRpcDown ? 'DOWN (using fallbacks)' : 'HEALTHY');

                // Test 2: Test safe contract calls
                console.log('ğŸ”§ Testing safe contract calls...');
                const rewardToken = await window.adminPage.safeContractCall(
                    () => contractManager.stakingContract.rewardToken(),
                    'FALLBACK_TOKEN'
                );
                console.log('âœ… Safe rewardToken call:', rewardToken);

                const actionCounter = await window.adminPage.safeContractCall(
                    () => contractManager.stakingContract.actionCounter(),
                    999
                );
                console.log('âœ… Safe actionCounter call:', actionCounter);

                // Test 3: Test demo proposals
                console.log('ğŸ”§ Testing demo proposals...');
                const demoProposals = window.adminPage.createDemoProposals();
                console.log('âœ… Demo proposals created:', demoProposals.length);
                demoProposals.forEach(p => {
                    console.log(`  - Demo Proposal ${p.id}: ${p.actionType} (${p.approvals}/${p.requiredApprovals} approvals)`);
                });

                // Test 4: Test contract stats loading
                console.log('ğŸ”§ Testing contract stats loading...');
                await window.adminPage.loadContractStats();
                console.log('âœ… Contract stats loaded with fallbacks');

                // Test 5: Test proposal loading
                console.log('ğŸ”§ Testing proposal loading with fallbacks...');
                const proposals = await window.adminPage.loadProposals();
                console.log('âœ… Proposals loaded:', proposals.length);
                proposals.forEach(p => {
                    console.log(`  - Proposal ${p.id}: ${p.actionType} (${p.approvals}/${p.requiredApprovals} approvals)`);
                });

                console.log('ğŸ‰ RPC health and fallback test completed!');
                console.log('âœ… System handles RPC issues gracefully like React version');

            } catch (error) {
                console.error('âŒ RPC health test failed:', error);
            }
        };

        // Test the complete admin panel with fallbacks
        window.testAdminPanelWithFallbacks = async function() {
            console.log('ğŸ§ª Testing complete admin panel with fallbacks...');

            try {
                // Test 1: Load contract stats
                console.log('ğŸ”§ Testing contract stats loading...');
                await window.adminPage.loadContractStats();
                console.log('âœ… Contract stats loaded');

                // Test 2: Load proposals with fallbacks
                console.log('ğŸ”§ Testing proposal loading with fallbacks...');
                const proposals = await window.adminPage.loadProposals();
                console.log('âœ… Proposals loaded:', proposals.length);

                if (proposals.length === 0) {
                    console.log('âš ï¸ No real proposals loaded, forcing demo proposals...');
                    const demoProposals = window.adminPage.createDemoProposals();
                    console.log('âœ… Demo proposals created:', demoProposals.length);

                    // Manually display demo proposals
                    window.adminPage.displayProposals(demoProposals);
                    console.log('âœ… Demo proposals displayed in UI');
                }

                // Test 3: Check UI elements
                console.log('ğŸ”§ Checking UI elements...');
                const proposalRows = document.querySelectorAll('.proposal-row, .proposal-item');
                console.log(`âœ… Found ${proposalRows.length} proposal elements in UI`);

                const approveButtons = document.querySelectorAll('[data-action="approve"], .approve-btn');
                const rejectButtons = document.querySelectorAll('[data-action="reject"], .reject-btn');
                console.log(`âœ… Found ${approveButtons.length} approve buttons and ${rejectButtons.length} reject buttons`);

                console.log('ğŸ‰ Admin panel test completed!');
                console.log('âœ… System shows proposals even when contract calls fail');

            } catch (error) {
                console.error('âŒ Admin panel test failed:', error);
            }
        };

        // Test the complete governance system like React version
        window.testCompleteGovernanceSystem = async function() {
            console.log('ğŸ§ª Testing complete governance system like React version...');

            try {
                // Test 1: Load contract information
                console.log('ğŸ”§ Testing contract information loading...');
                await window.adminPage.loadContractInformation();
                console.log('âœ… Contract information loaded');

                // Test 2: Check current signer
                console.log('ğŸ”§ Testing signer detection...');
                try {
                    const contractManager = await window.adminPage.ensureContractReady();
                    const currentSigner = await contractManager.getCurrentSigner();
                    console.log('âœ… Current signer:', currentSigner);
                } catch (error) {
                    console.log('âš ï¸ Signer detection failed (expected with RPC issues):', error.message);
                }

                // Test 3: Load proposals with proper error handling
                console.log('ğŸ”§ Testing proposal loading with error handling...');
                const proposals = await window.adminPage.loadProposals();
                console.log('âœ… Proposals loaded:', proposals.length);

                // Test 4: Check UI elements
                console.log('ğŸ”§ Testing UI elements...');
                const rewardBalanceEl = document.querySelector('[data-info="reward-balance"]');
                const hourlyRateEl = document.querySelector('[data-info="hourly-rate"]');
                const pairsEl = document.querySelector('[data-info="lp-pairs"]');
                const signersEl = document.querySelector('[data-info="signers"]');

                console.log('âœ… UI Elements found:', {
                    rewardBalance: !!rewardBalanceEl,
                    hourlyRate: !!hourlyRateEl,
                    pairs: !!pairsEl,
                    signers: !!signersEl
                });

                // Test 5: Test voting error handling
                console.log('ğŸ”§ Testing voting error handling...');
                console.log('â„¹ï¸ Try clicking approve/reject buttons to see proper error messages');

                console.log('ğŸ‰ Complete governance system test completed!');
                console.log('âœ… System shows real contract data and handles errors gracefully');
                console.log('âœ… Voting buttons show proper error messages for already voted proposals');
                console.log('âœ… Contract information panel displays real data from blockchain');

            } catch (error) {
                console.error('âŒ Complete governance system test failed:', error);
            }
        };

        // Test error handling specifically
        window.testErrorHandling = async function() {
            console.log('ğŸ§ª Testing error handling for voting...');

            try {
                // Test the error extraction logic
                const testError = {
                    technicalMessage: 'cannot estimate gas; transaction may fail or may require manual gas limit (reason="execution reverted: Already approved")',
                    message: 'UNPREDICTABLE_GAS_LIMIT'
                };

                console.log('ğŸ”§ Testing error message extraction...');

                // Simulate the error handling logic
                let errorMessage = '';
                if (testError.technicalMessage) {
                    errorMessage = testError.technicalMessage;
                } else if (testError.message) {
                    errorMessage = testError.message;
                }

                console.log('âœ… Extracted error message:', errorMessage);

                if (errorMessage.includes('Already approved') || errorMessage.includes('execution reverted: Already approved')) {
                    console.log('âœ… Would show: "You have already approved this proposal. Each signer can only vote once per proposal."');
                } else if (errorMessage.includes('Cannot reject after approving')) {
                    console.log('âœ… Would show: "You cannot reject a proposal you have already approved."');
                } else if (errorMessage.includes('UNPREDICTABLE_GAS_LIMIT')) {
                    console.log('âœ… Would show: "Transaction would fail. You may have already voted on this proposal."');
                }

                console.log('ğŸ‰ Error handling test completed!');
                console.log('âœ… The system will now show user-friendly error messages instead of technical errors');

            } catch (error) {
                console.error('âŒ Error handling test failed:', error);
            }
        };

        // Test the new voting system with proper error handling
        window.testVotingWithErrorHandling = async function() {
            console.log('ğŸ§ª Testing voting system with new error handling...');

            try {
                console.log('ğŸ”§ Testing approve action error handling...');

                // Try to approve a proposal (this should show user-friendly error)
                console.log('â„¹ï¸ Click an approve button to test the new error handling');
                console.log('âœ… Expected behavior:');
                console.log('   - If already approved: "âœ‹ You have already approved this proposal. Each signer can only vote once per proposal."');
                console.log('   - If successful: "âœ… Proposal approved successfully! Your vote has been recorded on the blockchain."');

                console.log('ğŸ”§ Testing reject action error handling...');
                console.log('â„¹ï¸ Click a reject button to test the new error handling');
                console.log('âœ… Expected behavior:');
                console.log('   - If cannot reject after approving: "âœ‹ You cannot reject a proposal you have already approved. Each signer can only vote once per proposal."');
                console.log('   - If successful: "âœ… Proposal rejected successfully! Your vote has been recorded on the blockchain."');

                console.log('ğŸ‰ Voting system test setup completed!');
                console.log('âœ… The system now returns proper success/error objects instead of throwing exceptions');
                console.log('âœ… User-friendly error messages will be displayed instead of technical errors');

            } catch (error) {
                console.error('âŒ Voting system test failed:', error);
            }
        };

        // Test the new React-like proposal loading
        window.testReactLikeProposalLoading = async function() {
            console.log('ğŸ§ª Testing React-like proposal loading...');

            try {
                console.log('ğŸ”§ Testing contract manager functions...');

                const contractManager = await window.adminPage.ensureContractReady();

                // Test all the new functions
                console.log('ğŸ“Š Testing getActionCounter...');
                const actionCounter = await contractManager.getActionCounter();
                console.log('âœ… Action counter:', actionCounter);

                console.log('ğŸ“Š Testing getRequiredApprovals...');
                const requiredApprovals = await contractManager.getRequiredApprovals();
                console.log('âœ… Required approvals:', requiredApprovals);

                console.log('ğŸ“Š Testing getSigners...');
                const signers = await contractManager.getSigners();
                console.log('âœ… Signers:', signers.length, 'addresses');

                console.log('ğŸ“Š Testing getTotalWeight...');
                const totalWeight = await contractManager.getTotalWeight();
                console.log('âœ… Total weight:', totalWeight.toString());

                console.log('ğŸ“Š Testing getPairs...');
                const pairs = await contractManager.getPairs();
                console.log('âœ… Pairs:', pairs.length, 'pairs');

                // Test loading proposals like React version
                if (actionCounter > 0) {
                    console.log('ğŸ“‹ Testing React-like proposal loading...');

                    for (let i = actionCounter; i > Math.max(actionCounter - 3, 0); i--) {
                        console.log(`ğŸ“‹ Loading action ${i}...`);

                        const proposal = await contractManager.getActions(i);
                        const pairs = await contractManager.getActionPairs(i);
                        const weights = await contractManager.getActionWeights(i);

                        if (proposal && !Array.isArray(proposal)) {
                            console.log(`âœ… Action ${i}:`, {
                                actionType: proposal.actionType,
                                executed: proposal.executed,
                                approvals: proposal.approvals,
                                pairs: pairs.length,
                                weights: weights.length
                            });
                        } else {
                            console.log(`âš ï¸ Action ${i} does not exist or returned empty array`);
                        }
                    }
                } else {
                    console.log('ğŸ“‹ No actions found in contract');
                }

                console.log('ğŸ‰ React-like proposal loading test completed!');

            } catch (error) {
                console.error('âŒ React-like proposal loading test failed:', error);
            }
        };

        // COMPREHENSIVE PROPOSAL DEBUG TEST
        window.debugProposals = async function() {
            console.log('ğŸ” COMPREHENSIVE PROPOSAL DEBUG TEST');
            console.log('=====================================');

            try {
                const contractManager = await window.adminPage.ensureContractReady();

                // Step 1: Test basic contract connectivity
                console.log('ğŸ”§ Step 1: Testing basic contract connectivity...');
                console.log('   - Contract address:', contractManager.stakingContract.address);
                console.log('   - Provider:', contractManager.provider.connection?.url || 'Unknown');
                console.log('   - Signer:', contractManager.signer ? 'Connected' : 'Not connected');

                // Step 2: Test action counter with detailed debugging
                console.log('ğŸ”§ Step 2: Testing action counter...');
                try {
                    const actionCounterRaw = await contractManager.stakingContract.actionCounter();
                    const actionCounterNum = actionCounterRaw.toNumber();
                    console.log('   âœ… Raw action counter:', actionCounterRaw);
                    console.log('   âœ… Action counter number:', actionCounterNum);

                    if (actionCounterNum === 0) {
                        console.log('   âš ï¸ ACTION COUNTER IS 0 - NO PROPOSALS EXIST IN CONTRACT!');
                        console.log('   ğŸ’¡ This means no proposals have been created yet.');
                        return;
                    }
                } catch (error) {
                    console.error('   âŒ Failed to get action counter:', error);
                    return;
                }

                // Step 3: Test individual action loading
                console.log('ğŸ”§ Step 3: Testing individual action loading...');
                const actionCounter = await contractManager.getActionCounter();

                for (let i = 1; i <= Math.min(actionCounter, 10); i++) {
                    console.log(`   ğŸ” Testing action ${i}:`);

                    try {
                        // Test actions() function
                        const actionRaw = await contractManager.stakingContract.actions(BigInt(i));
                        console.log(`     âœ… Raw action ${i}:`, actionRaw);

                        // Test getActions() wrapper
                        const actionWrapped = await contractManager.getActions(i);
                        console.log(`     âœ… Wrapped action ${i}:`, actionWrapped);

                        // Test action pairs
                        try {
                            const pairs = await contractManager.getActionPairs(i);
                            console.log(`     âœ… Action ${i} pairs:`, pairs);
                        } catch (pairError) {
                            console.log(`     âš ï¸ Action ${i} pairs failed:`, pairError.message);
                        }

                        // Test action weights
                        try {
                            const weights = await contractManager.getActionWeights(i);
                            console.log(`     âœ… Action ${i} weights:`, weights);
                        } catch (weightError) {
                            console.log(`     âš ï¸ Action ${i} weights failed:`, weightError.message);
                        }

                    } catch (error) {
                        console.log(`     âŒ Action ${i} failed:`, error.message);
                        console.log(`     ğŸ” Error details:`, {
                            code: error.code,
                            data: error.data,
                            reason: error.reason
                        });
                    }
                }

                // Step 4: Test contract ABI functions
                console.log('ğŸ”§ Step 4: Testing contract ABI functions...');
                const contractFunctions = Object.keys(contractManager.stakingContract.functions);
                console.log('   ğŸ“‹ Available contract functions:', contractFunctions.length);

                const actionRelatedFunctions = contractFunctions.filter(fn =>
                    fn.includes('action') || fn.includes('Action')
                );
                console.log('   ğŸ“‹ Action-related functions:', actionRelatedFunctions);

                // Step 5: Test proposal loading logic
                console.log('ğŸ”§ Step 5: Testing proposal loading logic...');
                try {
                    const proposals = await window.adminPage.loadProposals();
                    console.log('   âœ… Loaded proposals:', proposals.length);
                    console.log('   ğŸ“‹ Proposal details:', proposals);
                } catch (error) {
                    console.error('   âŒ Proposal loading failed:', error);
                }

                // Step 6: Check if contract has governance functions
                console.log('ğŸ”§ Step 6: Checking governance functions...');
                const governanceFunctions = [
                    'actions',
                    'getActionPairs',
                    'getActionWeights',
                    'actionCounter',
                    'REQUIRED_APPROVALS',
                    'approveAction',
                    'rejectAction'
                ];

                for (const funcName of governanceFunctions) {
                    const hasFunction = typeof contractManager.stakingContract[funcName] === 'function';
                    console.log(`   ${hasFunction ? 'âœ…' : 'âŒ'} ${funcName}: ${hasFunction ? 'Available' : 'Missing'}`);
                }

                console.log('ğŸ‰ PROPOSAL DEBUG TEST COMPLETED!');

            } catch (error) {
                console.error('âŒ Proposal debug test failed:', error);
            }
        };

        // Test the fixed proposal loading
        window.testFixedProposalLoading = async function() {
            console.log('ğŸ§ª TESTING FIXED PROPOSAL LOADING');
            console.log('==================================');

            try {
                const contractManager = await window.adminPage.ensureContractReady();

                // Test 1: Get action counter
                console.log('ğŸ”§ Step 1: Getting action counter...');
                const actionCounter = await contractManager.getActionCounter();
                console.log('   âœ… Action counter:', actionCounter);

                if (actionCounter === 0) {
                    console.log('   âš ï¸ No proposals exist in contract');
                    return;
                }

                // Test 2: Test fixed getActions function
                console.log('ğŸ”§ Step 2: Testing fixed getActions function...');
                for (let i = 1; i <= Math.min(actionCounter, 5); i++) {
                    console.log(`   ğŸ” Testing action ${i}:`);

                    try {
                        const action = await contractManager.getActions(i);
                        console.log(`     âœ… Action ${i} loaded:`, {
                            actionType: action?.actionType,
                            executed: action?.executed,
                            expired: action?.expired,
                            approvals: action?.approvals,
                            rejected: action?.rejected
                        });

                        if (action) {
                            console.log(`     ğŸ“‹ Full action ${i}:`, action);
                        }

                    } catch (error) {
                        console.log(`     âŒ Action ${i} failed:`, error.message);
                    }
                }

                // Test 3: Test proposal loading through AdminPage
                console.log('ğŸ”§ Step 3: Testing AdminPage proposal loading...');
                try {
                    const proposals = await window.adminPage.loadProposals();
                    console.log('   âœ… AdminPage loaded proposals:', proposals.length);

                    if (proposals.length > 0) {
                        console.log('   ğŸ“‹ First proposal:', proposals[0]);
                    }
                } catch (error) {
                    console.error('   âŒ AdminPage proposal loading failed:', error);
                }

                console.log('ğŸ‰ FIXED PROPOSAL LOADING TEST COMPLETED!');

            } catch (error) {
                console.error('âŒ Fixed proposal loading test failed:', error);
            }
        };

        // Simple test to see what the contract actually returns
        window.testRawContractCall = async function() {
            console.log('ğŸ” TESTING RAW CONTRACT CALLS');
            console.log('=============================');

            try {
                const contractManager = await window.adminPage.ensureContractReady();

                // Test 1: Direct contract call
                console.log('ğŸ”§ Step 1: Direct contract call...');
                try {
                    const rawResult = await contractManager.stakingContract.actions(BigInt(1));
                    console.log('   âœ… Raw result type:', typeof rawResult);
                    console.log('   âœ… Raw result is array:', Array.isArray(rawResult));
                    console.log('   âœ… Raw result length:', rawResult?.length);
                    console.log('   âœ… Raw result:', rawResult);

                    // Test accessing by index
                    if (rawResult) {
                        console.log('   ğŸ” Index access test:');
                        console.log('     - rawResult[0] (actionType):', rawResult[0]);
                        console.log('     - rawResult[11] (executed):', rawResult[11]);
                        console.log('     - rawResult[13] (approvals):', rawResult[13]);
                    }

                } catch (error) {
                    console.error('   âŒ Direct contract call failed:', error.message);
                }

                // Test 2: Through getActions wrapper
                console.log('ğŸ”§ Step 2: Through getActions wrapper...');
                try {
                    const wrappedResult = await contractManager.getActions(1);
                    console.log('   âœ… Wrapped result:', wrappedResult);
                } catch (error) {
                    console.error('   âŒ Wrapped call failed:', error.message);
                }

                // Test 3: Check if action exists
                console.log('ğŸ”§ Step 3: Checking if action 1 exists...');
                try {
                    const actionCounter = await contractManager.stakingContract.actionCounter();
                    console.log('   âœ… Action counter:', actionCounter.toString());

                    if (actionCounter.toNumber() >= 1) {
                        console.log('   âœ… Action 1 should exist');
                    } else {
                        console.log('   âš ï¸ Action 1 does not exist');
                    }
                } catch (error) {
                    console.error('   âŒ Action counter check failed:', error.message);
                }

                console.log('ğŸ‰ RAW CONTRACT CALL TEST COMPLETED!');

            } catch (error) {
                console.error('âŒ Raw contract call test failed:', error);
            }
        };

        // Test the final fix
        window.testFinalFix = async function() {
            console.log('ğŸ¯ TESTING FINAL ABI FIX');
            console.log('========================');

            try {
                const contractManager = await window.adminPage.ensureContractReady();

                // Test 1: Direct contract call with correct ABI
                console.log('ğŸ”§ Step 1: Testing corrected ABI...');
                try {
                    const rawResult = await contractManager.stakingContract.actions(BigInt(1));
                    console.log('   âœ… Raw result SUCCESS:', rawResult);
                    console.log('   âœ… Action type:', rawResult[0]);
                    console.log('   âœ… Executed:', rawResult[9]);
                    console.log('   âœ… Approvals:', rawResult[11]);
                } catch (error) {
                    console.error('   âŒ Direct call still failing:', error.message);
                }

                // Test 2: Through getActions wrapper
                console.log('ğŸ”§ Step 2: Testing getActions wrapper...');
                try {
                    const action = await contractManager.getActions(1);
                    console.log('   âœ… Wrapped result SUCCESS:', action);
                } catch (error) {
                    console.error('   âŒ Wrapped call failed:', error.message);
                }

                // Test 3: Load all proposals
                console.log('ğŸ”§ Step 3: Loading all proposals...');
                try {
                    const actionCounter = await contractManager.getActionCounter();
                    console.log(`   ğŸ“Š Testing all ${actionCounter} actions...`);

                    for (let i = 1; i <= actionCounter; i++) {
                        try {
                            const action = await contractManager.getActions(i);
                            if (action) {
                                console.log(`   âœ… Action ${i}: Type=${action.actionType}, Executed=${action.executed}, Approvals=${action.approvals}`);
                            } else {
                                console.log(`   âš ï¸ Action ${i}: null result`);
                            }
                        } catch (error) {
                            console.log(`   âŒ Action ${i}: ${error.message}`);
                        }
                    }
                } catch (error) {
                    console.error('   âŒ Proposal loading failed:', error.message);
                }

                console.log('ğŸ‰ FINAL FIX TEST COMPLETED!');

            } catch (error) {
                console.error('âŒ Final fix test failed:', error);
            }
        };

        // Test transaction RPC failover
        window.testTransactionRpcFailover = async function() {
            console.log('ğŸ”„ TESTING TRANSACTION RPC FAILOVER');
            console.log('===================================');

            try {
                const contractManager = await window.adminPage.ensureContractReady();

                // Test 1: Check current RPC
                console.log('ğŸ”§ Step 1: Current RPC status...');
                console.log('   Current RPC index:', contractManager.currentRpcIndex);
                console.log('   Current RPC URL:', contractManager.getCurrentRpcUrl());

                // Test 2: Test signer connection
                console.log('ğŸ”§ Step 2: Testing signer connection...');
                try {
                    await contractManager.ensureSigner();
                    const signerAddress = await contractManager.signer.getAddress();
                    console.log('   âœ… Signer connected:', signerAddress);
                } catch (error) {
                    console.error('   âŒ Signer connection failed:', error.message);
                    return;
                }

                // Test 3: Test a simple transaction (hourly rate proposal)
                console.log('ğŸ”§ Step 3: Testing transaction with RPC failover...');
                console.log('   ğŸ“ Attempting to create hourly rate proposal...');

                try {
                    const result = await contractManager.proposeSetHourlyRewardRate(100);
                    console.log('   âœ… Transaction successful:', result.hash);
                    console.log('   ğŸ“Š Gas used:', result.gasUsed?.toString());
                    console.log('   ğŸ”— Block number:', result.blockNumber);
                } catch (error) {
                    console.error('   âŒ Transaction failed:', error.message);
                    console.log('   ğŸ” Error details:', error);

                    // Check if RPC switched during error
                    console.log('   ğŸ“Š RPC index after error:', contractManager.currentRpcIndex);
                    console.log('   ğŸ“Š RPC URL after error:', contractManager.getCurrentRpcUrl());
                }

                console.log('ğŸ‰ TRANSACTION RPC FAILOVER TEST COMPLETED!');

            } catch (error) {
                console.error('âŒ Transaction RPC failover test failed:', error);
            }
        };

        // Test pair loading for modals
        window.testPairLoading = async function() {
            console.log('ğŸ” TESTING PAIR LOADING FOR MODALS');
            console.log('==================================');

            try {
                const contractManager = await window.adminPage.ensureContractReady();

                // Test 1: Check contract methods
                console.log('ğŸ”§ Step 1: Testing contract pair methods...');

                try {
                    const pairs1 = await contractManager.stakingContract.getPairs();
                    console.log('   âœ… getPairs() result:', pairs1);
                } catch (error) {
                    console.log('   âŒ getPairs() failed:', error.message);
                }

                try {
                    const pairs2 = await contractManager.stakingContract.getActivePairs();
                    console.log('   âœ… getActivePairs() result:', pairs2);
                } catch (error) {
                    console.log('   âŒ getActivePairs() failed:', error.message);
                }

                // Test 2: Check getAllPairsInfo method
                console.log('ğŸ”§ Step 2: Testing getAllPairsInfo...');
                try {
                    const allPairs = await contractManager.getAllPairsInfo();
                    console.log('   âœ… getAllPairsInfo() result:', allPairs);
                    console.log('   ğŸ“Š Number of pairs found:', allPairs.length);

                    if (allPairs.length > 0) {
                        allPairs.forEach((pair, index) => {
                            console.log(`   ğŸ“‹ Pair ${index + 1}: ${pair.name} (${pair.address}) - Weight: ${pair.weight}`);
                        });
                    }
                } catch (error) {
                    console.error('   âŒ getAllPairsInfo() failed:', error);
                }

                // Test 3: Check approved proposals
                console.log('ğŸ”§ Step 3: Checking approved Add Pair proposals...');
                try {
                    const actionCounter = await contractManager.getActionCounter();
                    console.log('   ğŸ“Š Total actions:', actionCounter);

                    let approvedPairs = 0;
                    for (let i = actionCounter; i > Math.max(actionCounter - 10, 0); i--) {
                        try {
                            const action = await contractManager.getActions(i);
                            if (action && action.actionType === 2) { // Add Pair
                                console.log(`   ğŸ“‹ Action ${i}: ${action.executed ? 'âœ… Executed' : 'â³ Pending'} - ${action.pairNameToAdd} (${action.pairToAdd})`);
                                if (action.executed && !action.rejected) {
                                    approvedPairs++;
                                }
                            }
                        } catch (error) {
                            // Skip failed actions
                        }
                    }
                    console.log(`   ğŸ“Š Approved pairs found: ${approvedPairs}`);
                } catch (error) {
                    console.error('   âŒ Failed to check proposals:', error);
                }

                console.log('ğŸ‰ PAIR LOADING TEST COMPLETED!');

            } catch (error) {
                console.error('âŒ Pair loading test failed:', error);
            }
        };

        // Test the fixed pair loading
        window.testFixedPairLoading = async function() {
            console.log('ğŸ”§ TESTING FIXED PAIR LOADING');
            console.log('=============================');

            try {
                const contractManager = await window.adminPage.ensureContractReady();

                // Test the fixed getAllPairsInfo method
                console.log('ğŸ”§ Testing fixed getAllPairsInfo...');
                const allPairs = await contractManager.getAllPairsInfo();
                console.log('   âœ… Fixed getAllPairsInfo() result:', allPairs);
                console.log('   ğŸ“Š Number of pairs found:', allPairs.length);

                if (allPairs.length > 0) {
                    allPairs.forEach((pair, index) => {
                        console.log(`   ğŸ“‹ Pair ${index + 1}:`);
                        console.log(`      Name: ${pair.name}`);
                        console.log(`      Address: ${pair.address}`);
                        console.log(`      Platform: ${pair.platform}`);
                        console.log(`      Weight: ${pair.weight}`);
                        console.log(`      Active: ${pair.isActive}`);
                    });

                    // Test modal loading
                    console.log('ğŸ”§ Testing modal pair loading...');

                    // Test remove pair modal
                    console.log('   ğŸ“‹ Testing loadPairsForRemoval...');
                    await window.adminPage.loadPairsForRemoval();

                    // Test weight update modal
                    console.log('   ğŸ“‹ Testing loadPairsForWeightUpdate...');
                    await window.adminPage.loadPairsForWeightUpdate();

                    console.log('   âœ… Modal loading tests completed');
                } else {
                    console.log('   âš ï¸ No pairs found - modals will show "No pairs available"');
                }

                console.log('ğŸ‰ FIXED PAIR LOADING TEST COMPLETED!');

            } catch (error) {
                console.error('âŒ Fixed pair loading test failed:', error);
            }
        };

        // Test modal functionality
        window.testModalFunctionality = async function() {
            console.log('ğŸ”§ TESTING MODAL FUNCTIONALITY');
            console.log('==============================');

            try {
                // Test 1: Check if modals open and show buttons
                console.log('ğŸ”§ Step 1: Testing modal button visibility...');

                const modalTypes = [
                    { name: 'Change Signer', action: 'change-signer' },
                    { name: 'Remove Pair', action: 'remove-pair' },
                    { name: 'Update Pair Weights', action: 'update-weights' }
                ];

                for (const modal of modalTypes) {
                    console.log(`   ğŸ“‹ Testing ${modal.name} modal...`);

                    // Find and click the button
                    const button = document.querySelector(`[data-action="${modal.action}"]`);
                    if (button) {
                        button.click();

                        // Wait for modal to open
                        await new Promise(resolve => setTimeout(resolve, 500));

                        // Check modal elements
                        const modalContainer = document.getElementById('modal-container');
                        const modalFooter = modalContainer?.querySelector('.modal-footer');
                        const buttons = modalContainer?.querySelectorAll('.modal-footer button');

                        console.log(`     - Modal container: ${modalContainer ? 'âœ… Found' : 'âŒ Not found'}`);
                        console.log(`     - Modal footer: ${modalFooter ? 'âœ… Found' : 'âŒ Not found'}`);
                        console.log(`     - Footer buttons: ${buttons?.length || 0}`);

                        if (buttons && buttons.length > 0) {
                            buttons.forEach((btn, index) => {
                                console.log(`       Button ${index + 1}: "${btn.textContent.trim()}" (visible: ${btn.offsetWidth > 0 && btn.offsetHeight > 0})`);
                            });
                        }

                        // Close modal
                        const closeBtn = modalContainer?.querySelector('.modal-close');
                        if (closeBtn) {
                            closeBtn.click();
                            await new Promise(resolve => setTimeout(resolve, 200));
                        }
                    } else {
                        console.log(`     âŒ Button not found for ${modal.name}`);
                    }
                }

                console.log('ğŸ‰ MODAL FUNCTIONALITY TEST COMPLETED!');

            } catch (error) {
                console.error('âŒ Modal functionality test failed:', error);
            }
        };

        // Test AdminPage loading
        window.testAdminPageLoading = function() {
            console.log('ğŸ”§ TESTING ADMINPAGE LOADING');
            console.log('============================');

            console.log('ğŸ“‹ Checking class availability:');
            console.log('  - AdminPage:', typeof AdminPage !== 'undefined' ? 'âœ… Available' : 'âŒ Missing');
            console.log('  - ContractManager:', typeof ContractManager !== 'undefined' ? 'âœ… Available' : 'âŒ Missing');
            console.log('  - WalletManager:', typeof WalletManager !== 'undefined' ? 'âœ… Available' : 'âŒ Missing');

            console.log('ğŸ“‹ Checking window objects:');
            console.log('  - window.AdminPage:', typeof window.AdminPage !== 'undefined' ? 'âœ… Available' : 'âŒ Missing');
            console.log('  - window.adminPage:', typeof window.adminPage !== 'undefined' ? 'âœ… Available' : 'âŒ Missing');

            if (typeof AdminPage !== 'undefined') {
                try {
                    console.log('ğŸ”§ Testing AdminPage instantiation...');
                    const testInstance = new AdminPage();
                    console.log('âœ… AdminPage can be instantiated successfully');
                    console.log('ğŸ“‹ Instance properties:', {
                        isInitialized: testInstance.isInitialized,
                        isAuthorized: testInstance.isAuthorized,
                        DEVELOPMENT_MODE: testInstance.DEVELOPMENT_MODE
                    });
                } catch (error) {
                    console.error('âŒ AdminPage instantiation failed:', error);
                }
            }

            console.log('ğŸ‰ ADMINPAGE LOADING TEST COMPLETED!');
        };

        // Test enhanced proposal display
        window.testEnhancedProposalDisplay = function() {
            console.log('ğŸ¨ TESTING ENHANCED PROPOSAL DISPLAY');
            console.log('===================================');

            try {
                if (!window.adminPage) {
                    console.error('âŒ AdminPage not available');
                    return;
                }

                console.log('ğŸ“‹ Checking proposal display enhancements:');

                // Check if proposals are loaded
                const proposalsTable = document.querySelector('#proposals-tbody');
                if (!proposalsTable) {
                    console.warn('âš ï¸ Proposals table not found');
                    return;
                }

                const proposalRows = proposalsTable.querySelectorAll('.proposal-row');
                console.log(`  - Found ${proposalRows.length} proposal rows`);

                proposalRows.forEach((row, index) => {
                    const proposalId = row.querySelector('.proposal-id')?.textContent;
                    const proposalSummary = row.querySelector('.proposal-summary')?.textContent;
                    const actionType = row.querySelector('.action-type')?.textContent;
                    const expandBtn = row.querySelector('.expand-btn');

                    console.log(`  ğŸ“‹ Proposal ${index + 1}:`);
                    console.log(`    - ID: ${proposalId}`);
                    console.log(`    - Type: ${actionType}`);
                    console.log(`    - Summary: ${proposalSummary}`);
                    console.log(`    - Expandable: ${expandBtn ? 'âœ… Yes' : 'âŒ No'}`);

                    // Check if details row exists
                    const detailsRowId = proposalId ? `details-${proposalId.replace('#', '')}` : null;
                    const detailsRow = detailsRowId ? document.getElementById(detailsRowId) : null;
                    console.log(`    - Details row: ${detailsRow ? 'âœ… Found' : 'âŒ Missing'}`);
                });

                // Test expand functionality
                const firstExpandBtn = document.querySelector('.expand-btn');
                if (firstExpandBtn) {
                    console.log('ğŸ”§ Testing expand functionality...');
                    firstExpandBtn.click();

                    setTimeout(() => {
                        const expandedDetails = document.querySelector('.proposal-details-row[style*="table-row"]');
                        console.log(`  - Expansion works: ${expandedDetails ? 'âœ… Yes' : 'âŒ No'}`);

                        if (expandedDetails) {
                            const parameterCards = expandedDetails.querySelectorAll('.parameter-card');
                            console.log(`  - Parameter cards: ${parameterCards.length}`);

                            parameterCards.forEach((card, cardIndex) => {
                                const label = card.querySelector('.parameter-label')?.textContent;
                                const value = card.querySelector('.parameter-value')?.textContent;
                                console.log(`    Card ${cardIndex + 1}: ${label} = ${value}`);
                            });
                        }

                        console.log('ğŸ‰ ENHANCED PROPOSAL DISPLAY TEST COMPLETED!');
                    }, 500);
                } else {
                    console.log('ğŸ‰ ENHANCED PROPOSAL DISPLAY TEST COMPLETED!');
                }

            } catch (error) {
                console.error('âŒ Enhanced proposal display test failed:', error);
            }
        };

        // Force refresh proposals to see enhanced display
        window.forceRefreshProposals = function() {
            console.log('ğŸ”„ FORCING PROPOSAL REFRESH');
            console.log('===========================');

            if (!window.adminPage) {
                console.error('âŒ AdminPage not available');
                return;
            }

            console.log('ğŸ”„ Refreshing proposals...');
            window.adminPage.loadProposals().then(proposals => {
                console.log(`ğŸ“‹ Loaded ${proposals.length} proposals`);

                proposals.forEach((proposal, index) => {
                    console.log(`\nğŸ“‹ Proposal ${index + 1}:`);
                    console.log(`  - ID: ${proposal.id}`);
                    console.log(`  - Action Type: ${proposal.actionType}`);
                    console.log(`  - Summary: ${window.adminPage.getProposalSummary(proposal)}`);

                    // Show enhanced data
                    const enhancedFields = ['pairToAdd', 'pairNameToAdd', 'platformToAdd', 'weightToAdd',
                                          'newHourlyRewardRate', 'pairToRemove', 'recipient', 'withdrawAmount'];
                    enhancedFields.forEach(field => {
                        if (proposal[field] !== undefined) {
                            console.log(`  - ${field}: ${proposal[field]}`);
                        }
                    });
                });

                // Refresh the UI
                console.log('ğŸ”„ Refreshing UI...');
                window.adminPage.loadMultiSignPanel();

                console.log('ğŸ‰ FORCE REFRESH COMPLETED!');
            }).catch(error => {
                console.error('âŒ Force refresh failed:', error);
            });
        };

        // Test all the fixes comprehensively
        window.testAllFixes = async function() {
            console.log('ğŸ§ª Testing all fixes comprehensively...');

            try {
                // Test 1: RPC failover system
                console.log('ğŸ”§ Test 1: RPC failover system...');
                await testRpcFailover();

                // Test 2: Proposal debugging
                console.log('ğŸ”§ Test 2: Proposal debugging...');
                await debugProposals();

                // Test 3: Contract manager functions
                console.log('ğŸ”§ Test 3: Contract manager functions...');
                await testReactLikeProposalLoading();

                // Test 4: Proposal loading
                console.log('ğŸ”§ Test 4: Proposal loading...');
                const proposals = await window.adminPage.loadProposals();
                console.log('âœ… Loaded proposals:', proposals.length);

                // Test 5: Contract information loading
                console.log('ğŸ”§ Test 5: Contract information loading...');
                await window.adminPage.loadContractInformation();
                console.log('âœ… Contract information loaded');

                // Test 6: Error handling
                console.log('ğŸ”§ Test 6: Error handling...');
                await testVotingWithErrorHandling();

                console.log('ğŸ‰ All fixes tested successfully!');

            } catch (error) {
                console.error('âŒ Comprehensive test failed:', error);
            }
        };

        // Test RPC failover system
        window.testRpcFailover = async function() {
            console.log('ğŸ§ª Testing RPC failover system...');

            try {
                const contractManager = await window.adminPage.ensureContractReady();

                // Test 1: Check current RPC configuration
                console.log('ğŸ“Š Current RPC configuration:');
                console.log('   - Current RPC Index:', contractManager.currentRpcIndex || 0);
                console.log('   - Available RPCs:', contractManager.rpcUrls?.length || 'N/A');
                console.log('   - Fallback RPCs:', contractManager.config?.fallbackRPCs?.length || 'N/A');
                console.log('   - RPC URLs:', contractManager.rpcUrls || contractManager.config?.fallbackRPCs || 'N/A');

                // Test 2: Test safe contract calls with specific error handling
                console.log('ğŸ”§ Testing safe contract calls...');

                const actionCounter = await contractManager.safeContractCall(
                    () => contractManager.stakingContract.actionCounter(),
                    0,
                    'actionCounter'
                );
                console.log('âœ… Safe actionCounter call:', actionCounter);

                const requiredApprovals = await contractManager.safeContractCall(
                    () => contractManager.stakingContract.REQUIRED_APPROVALS(),
                    3,
                    'REQUIRED_APPROVALS'
                );
                console.log('âœ… Safe REQUIRED_APPROVALS call:', requiredApprovals);

                // Test 3: Test RPC health check
                console.log('ğŸ”§ Testing RPC health check...');
                const isRpcDown = await window.adminPage.checkRpcHealth(contractManager);
                console.log('âœ… RPC health check result:', isRpcDown ? 'âŒ RPC Down' : 'âœ… RPC Healthy');

                // Test 4: Test RPC switching capability
                console.log('ğŸ”§ Testing RPC switching capability...');
                if (contractManager.switchToNextProvider) {
                    try {
                        const originalIndex = contractManager.currentProviderIndex || 0;
                        await contractManager.switchToNextProvider();
                        const newIndex = contractManager.currentProviderIndex || 0;
                        console.log('âœ… RPC switch test:', `${originalIndex} â†’ ${newIndex}`);
                    } catch (error) {
                        console.log('âš ï¸ RPC switch test failed:', error.message);
                    }
                } else {
                    console.log('âš ï¸ switchToNextProvider method not available');
                }

                // Test 5: Test error code detection
                console.log('ğŸ”§ Testing error code detection...');
                const testErrors = [
                    { code: -32603, message: 'Internal JSON-RPC error' },
                    { message: 'missing trie node' },
                    { message: 'missing revert data' },
                    { code: 'NETWORK_ERROR' },
                    { message: 'could not detect network' }
                ];

                testErrors.forEach(error => {
                    const isRpcError = error.code === -32603 ||
                                     error.code === 'NETWORK_ERROR' ||
                                     error.message.includes('missing trie node') ||
                                     error.message.includes('Internal JSON-RPC error') ||
                                     error.message.includes('missing revert data') ||
                                     error.message.includes('could not detect network');
                    console.log(`   - ${JSON.stringify(error)}: ${isRpcError ? 'âœ… Will trigger RPC switch' : 'âŒ Regular error'}`);
                });

                console.log('ğŸ‰ RPC failover system test completed!');

            } catch (error) {
                console.error('âŒ RPC failover test failed:', error);
            }
        };

        // Test contract deployment and state
        window.testContractState = async function() {
            console.log('ğŸ” TESTING CONTRACT STATE AND DEPLOYMENT');
            console.log('========================================');

            try {
                const contractManager = await window.adminPage.ensureContractReady();

                // Test 1: Basic contract info
                console.log('ğŸ”§ Step 1: Basic contract information...');
                console.log('   - Contract Address:', contractManager.stakingContract.address);
                console.log('   - Provider URL:', contractManager.provider.connection?.url);

                // Test 2: Check if contract exists at address
                console.log('ğŸ”§ Step 2: Checking contract existence...');
                try {
                    const code = await contractManager.provider.getCode(contractManager.stakingContract.address);
                    console.log('   - Contract code length:', code.length);
                    console.log('   - Contract exists:', code !== '0x');

                    if (code === '0x') {
                        console.log('   âŒ NO CONTRACT DEPLOYED AT THIS ADDRESS!');
                        return;
                    }
                } catch (error) {
                    console.error('   âŒ Failed to check contract code:', error);
                }

                // Test 3: Test basic contract functions
                console.log('ğŸ”§ Step 3: Testing basic contract functions...');

                try {
                    const rewardToken = await contractManager.stakingContract.rewardToken();
                    console.log('   âœ… Reward token:', rewardToken);
                } catch (error) {
                    console.log('   âŒ rewardToken() failed:', error.message);
                }

                try {
                    const hourlyRate = await contractManager.stakingContract.hourlyRewardRate();
                    console.log('   âœ… Hourly rate:', hourlyRate.toString());
                } catch (error) {
                    console.log('   âŒ hourlyRewardRate() failed:', error.message);
                }

                // Test 4: Test governance-specific functions
                console.log('ğŸ”§ Step 4: Testing governance functions...');

                try {
                    const actionCounter = await contractManager.stakingContract.actionCounter();
                    console.log('   âœ… Action counter (raw):', actionCounter);
                    console.log('   âœ… Action counter (number):', actionCounter.toNumber());

                    if (actionCounter.toNumber() === 0) {
                        console.log('   ğŸ’¡ DIAGNOSIS: Contract has 0 proposals - this is why nothing loads!');
                        console.log('   ğŸ’¡ SOLUTION: Create some test proposals first.');
                    }
                } catch (error) {
                    console.log('   âŒ actionCounter() failed:', error.message);
                    console.log('   ğŸ’¡ DIAGNOSIS: Contract may not have governance functions!');
                }

                try {
                    const requiredApprovals = await contractManager.stakingContract.REQUIRED_APPROVALS();
                    console.log('   âœ… Required approvals:', requiredApprovals.toString());
                } catch (error) {
                    console.log('   âŒ REQUIRED_APPROVALS() failed:', error.message);
                }

                // Test 5: Check if we can create a proposal
                console.log('ğŸ”§ Step 5: Testing proposal creation capability...');

                if (contractManager.signer) {
                    try {
                        // Test if we have admin role
                        const signerAddress = await contractManager.signer.getAddress();
                        console.log('   - Signer address:', signerAddress);

                        const hasAdmin = await contractManager.hasAdminRole(signerAddress);
                        console.log('   - Has admin role:', hasAdmin);

                        if (!hasAdmin) {
                            console.log('   ğŸ’¡ DIAGNOSIS: Current signer is not an admin - cannot create proposals');
                        }

                    } catch (error) {
                        console.log('   âŒ Admin role check failed:', error.message);
                    }
                } else {
                    console.log('   âš ï¸ No signer connected - cannot test proposal creation');
                }

                // Test 6: Check contract version/deployment
                console.log('ğŸ”§ Step 6: Contract deployment verification...');

                try {
                    // Try to get contract creation block
                    const currentBlock = await contractManager.provider.getBlockNumber();
                    console.log('   - Current block:', currentBlock);

                    // Check recent transactions to this contract
                    const filter = {
                        address: contractManager.stakingContract.address,
                        fromBlock: Math.max(0, currentBlock - 1000),
                        toBlock: 'latest'
                    };

                    const logs = await contractManager.provider.getLogs(filter);
                    console.log('   - Recent contract interactions:', logs.length);

                    if (logs.length === 0) {
                        console.log('   ğŸ’¡ DIAGNOSIS: No recent contract activity - contract may be newly deployed or unused');
                    }

                } catch (error) {
                    console.log('   âŒ Contract activity check failed:', error.message);
                }

                console.log('ğŸ‰ CONTRACT STATE TEST COMPLETED!');

            } catch (error) {
                console.error('âŒ Contract state test failed:', error);
            }
        };

        // Emergency modal test function
        window.testEmergencyModal = function() {
            console.log('ğŸ§ª EMERGENCY: Testing modal system...');

            const modalContainer = document.getElementById('modal-container');
            if (!modalContainer) {
                console.error('âŒ EMERGENCY: Modal container not found!');
                alert('âŒ Modal container not found!');
                return;
            }

            console.log('âœ… EMERGENCY: Modal container found');

            modalContainer.innerHTML = `
                <div style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 255, 0, 0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 99999;
                " onclick="document.getElementById('modal-container').style.display='none'; document.getElementById('modal-container').innerHTML='';">
                    <div style="
                        background: white;
                        padding: 30px;
                        border-radius: 10px;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                        max-width: 500px;
                        width: 90%;
                        text-align: center;
                        color: black;
                        font-family: Arial, sans-serif;
                    " onclick="event.stopPropagation();">
                        <h2 style="color: #28a745; margin-bottom: 20px;">ğŸ§ª EMERGENCY MODAL TEST</h2>
                        <p style="margin-bottom: 20px;">If you can see this modal, the modal system is working!</p>
                        <p style="margin-bottom: 20px; color: #666;">This means the issue is with the admin modal HTML or CSS.</p>
                        <button onclick="document.getElementById('modal-container').style.display='none'; document.getElementById('modal-container').innerHTML='';"
                                style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            Close Test Modal
                        </button>
                    </div>
                </div>
            `;

            modalContainer.style.display = 'flex';
            console.log('âœ… EMERGENCY: Test modal displayed');
        };

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (adminPage) {
                adminPage.destroy();
            }
        });
    </script>

    <style>
        /* Loading styles for initial state */
        .admin-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #ffffff;
        }

        .loading-container {
            text-align: center;
            padding: 40px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #00d4ff;
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto 20px;
        }

        .loading-container h2 {
            margin: 0 0 10px 0;
            font-size: 24px;
            font-weight: 600;
            color: #ffffff;
        }

        .loading-container p {
            margin: 0;
            color: #a0a0a0;
            font-size: 16px;
        }

        .error-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #ffffff;
            text-align: center;
            padding: 40px;
        }

        .error-container h2 {
            margin: 0 0 15px 0;
            color: #ff6b6b;
            font-size: 24px;
        }

        .error-container p {
            margin: 0 0 25px 0;
            color: #a0a0a0;
            max-width: 500px;
            line-height: 1.6;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #error-boundary {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
        }
    </style>
</body>
</html>
