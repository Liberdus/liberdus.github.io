<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LP Staking - Admin Panel</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/admin-theme.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/admin.css">
    <link rel="stylesheet" href="css/admin-homepage-theme.css">
    
    <!-- Meta Tags -->
    <meta name="description" content="LP Staking Admin Panel - Manage liquidity provider staking contracts">
    <meta name="keywords" content="DeFi, LP Staking, Admin, Blockchain, Ethereum, Polygon">
    <meta name="author" content="LP Staking Protocol">
    
    <!-- Open Graph -->
    <meta property="og:title" content="LP Staking - Admin Panel">
    <meta property="og:description" content="Administrative interface for LP Staking Protocol">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://lpstaking.example.com/admin">
    
    <!-- Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
</head>
<body>
    <!-- Admin Panel Container -->
    <div id="admin-content">
        <!-- Loading state while initializing -->
        <div class="admin-loading">
            <div class="loading-container">
                <div class="loading-spinner"></div>
                <h2>üîê Initializing Admin Panel</h2>
                <p>Verifying administrator privileges...</p>
            </div>
        </div>
    </div>

    <!-- Modal Container (ADDED) -->
    <div id="modal-container" style="display: none;"></div>

    <!-- Error Boundary -->
    <div id="error-boundary" style="display: none;">
        <div class="error-container">
            <h2>‚ùå System Error</h2>
            <p id="error-message">An unexpected error occurred.</p>
            <button class="btn btn-primary" onclick="location.reload()">
                Reload Page
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Configuration (load first) -->
    <script src="js/config/app-config.js"></script>
    <script src="js/config/dev-config.js"></script>

    <!-- Core Libraries with fallbacks -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js" onerror="loadEthersFallback()"></script>
    <script>
        function loadEthersFallback() {
            console.log('Primary ethers CDN failed, trying local fallback...');
            const script = document.createElement('script');
            script.src = 'libs/ethers.umd.min.js';
            script.onerror = () => {
                console.error('‚ùå All ethers sources failed');
                document.getElementById('error-boundary').style.display = 'flex';
                document.getElementById('error-boundary').innerHTML = `
                    <div class="error-container">
                        <h2>‚ùå Critical Error</h2>
                        <p>Ethers.js library failed to load. Please refresh the page or check your internet connection.</p>
                    </div>
                `;
            };
            document.head.appendChild(script);
        }

        // Verify ethers loaded
        window.addEventListener('load', function() {
            setTimeout(() => {
                if (typeof ethers === 'undefined') {
                    console.error('‚ùå Ethers.js not loaded after page load');
                    loadEthersFallback();
                } else {
                    console.log('‚úÖ Ethers.js loaded successfully:', ethers.version);
                }
            }, 1000);
        });
    </script>

    <!-- Theme System (load early to prevent flash) -->
    <script src="js/core/unified-theme-manager.js"></script>

    <!-- Core System -->
    <script src="js/debug-logger.js"></script>
    <script src="js/utils/unified-cache.js"></script>
    <script src="js/utils/cache-integration.js"></script>
    <script src="js/utils/logger.js"></script>
    <script src="js/utils/event-manager.js"></script>
    <script src="js/utils/storage-manager.js"></script>
    <script src="js/utils/network-health-check.js"></script>
    <script src="js/core/error-handler.js"></script>
    <script src="js/core/notification-manager.js"></script>
    
    <!-- Wallet Integration -->
    <script src="js/wallet/wallet-manager.js"></script>
    <script src="js/wallet/metamask-connector.js"></script>
    <script src="js/wallet/walletconnect-connector.js"></script>
    
    <!-- Contract System -->
    <script src="js/contracts/contract-manager.js"></script>
    
    <!-- Performance Optimization Components -->
    <script src="js/components/optimized-admin-state.js"></script>
    <script src="js/components/optimistic-ui-updates.js"></script>
    <script src="js/components/efficient-dom-updates.js"></script>
    <script src="js/components/performance-monitor.js"></script>

    <!-- Admin Components -->
    <script src="js/components/admin-page.js"></script>

    <!-- Admin Testing Utility -->
    <script src="js/utils/admin-test.js"></script>

    <!-- Master Initializer -->
    <script src="js/master-initializer.js"></script>

    <script>
        // Debug initialization
        console.log('üîß ADMIN DEBUG: Page scripts loading...');

        // Check dependencies periodically
        let checkCount = 0;
        const maxChecks = 20;

        function checkDependencies() {
            checkCount++;
            console.log(`üîß ADMIN DEBUG: Dependency check ${checkCount}/${maxChecks}`);
            console.log('üîß ADMIN DEBUG: Dependencies status:', {
                ethers: typeof window.ethers !== 'undefined',
                CONFIG: typeof window.CONFIG !== 'undefined',
                contractManager: typeof window.contractManager !== 'undefined',
                adminPage: typeof window.adminPage !== 'undefined'
            });

            if (typeof window.ethers !== 'undefined' &&
                typeof window.CONFIG !== 'undefined' &&
                typeof window.ContractManager !== 'undefined') {

                // Try to initialize ContractManager if it doesn't exist
                if (typeof window.contractManager === 'undefined') {
                    console.log('üîß ADMIN DEBUG: Initializing ContractManager...');
                    try {
                        window.contractManager = new ContractManager();
                        console.log('‚úÖ ADMIN DEBUG: ContractManager created');
                    } catch (error) {
                        console.error('‚ùå ADMIN DEBUG: Failed to create ContractManager:', error);
                        console.error('‚ùå ADMIN DEBUG: Error details:', error.message);
                        console.error('‚ùå ADMIN DEBUG: Error stack:', error.stack);
                    }
                }

                if (typeof window.contractManager !== 'undefined') {
                    console.log('‚úÖ ADMIN DEBUG: All dependencies loaded!');
                    return true;
                }
            } else {
                // Enhanced debugging for missing dependencies
                console.log('üîç ADMIN DEBUG: Dependency check status:');
                console.log('  - ethers:', typeof window.ethers !== 'undefined' ? '‚úÖ' : '‚ùå');
                console.log('  - CONFIG:', typeof window.CONFIG !== 'undefined' ? '‚úÖ' : '‚ùå');
                console.log('  - ContractManager class:', typeof window.ContractManager !== 'undefined' ? '‚úÖ' : '‚ùå');
            }

            if (checkCount < maxChecks) {
                setTimeout(checkDependencies, 500);
            } else {
                console.error('‚ùå ADMIN DEBUG: Dependencies failed to load after 10 seconds');
            }
            return false;
        }

        // Start checking after a short delay
        setTimeout(checkDependencies, 1000);

        // Prevent duplicate script loading and initialization
        if (window.adminPanelLoaded) {
            console.log('‚ö†Ô∏è Admin panel already loaded, skipping initialization');
        } else {
            window.adminPanelLoaded = true;
            console.log('üîê Admin panel scripts loading...');
        }

        // Global error handler
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            showErrorBoundary(event.error.message);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            showErrorBoundary(event.reason.message || 'Promise rejection');
        });

        function showErrorBoundary(message) {
            document.getElementById('admin-content').style.display = 'none';
            document.getElementById('error-boundary').style.display = 'flex';
            document.getElementById('error-message').textContent = message;
        }

        // Admin Panel Initialization
        let adminPage = null;

        async function initializeAdminPanel() {
            try {
                console.log('üöÄ Starting Admin Panel initialization...');

                // Debug: Check what's available
                console.log('üîç System check:');
                console.log('  - ethers:', !!window.ethers);
                console.log('  - WalletManager class:', !!window.WalletManager);
                console.log('  - walletManager instance:', !!window.walletManager);
                console.log('  - masterInitializer:', !!window.masterInitializer);
                console.log('  - AdminPage class:', !!window.AdminPage);

                // ENHANCED: More flexible initialization with timeout
                try {
                    if (!window.masterInitializer) {
                        console.log('‚è≥ Waiting for master initializer...');
                        await waitForMasterInitializer(15000); // Shorter timeout
                    }

                    // Initialize master system
                    if (window.masterInitializer && !window.masterInitializer.isInitialized) {
                        console.log('üîß Initializing master system...');
                        await window.masterInitializer.init();
                    }
                } catch (initError) {
                    console.warn('‚ö†Ô∏è Master initialization failed, proceeding with basic setup:', initError.message);

                    // Basic fallback initialization
                    if (!window.contractManager && window.ContractManager) {
                        console.log('üîó Creating contract manager directly...');
                        window.contractManager = new ContractManager();
                        await window.contractManager.init();
                    }
                }

                // Debug: Check wallet manager after initialization
                console.log('üîç Post-init check:');
                console.log('  - walletManager:', !!window.walletManager);
                if (window.walletManager) {
                    console.log('  - connectWallet method:', typeof window.walletManager.connectWallet);
                    console.log('  - connectMetaMask method:', typeof window.walletManager.connectMetaMask);
                    console.log('  - isConnected method:', typeof window.walletManager.isConnected);
                }

                // Check if AdminPage is available
                if (typeof AdminPage === 'undefined') {
                    throw new Error('AdminPage class not loaded. Check if admin-page.js is loading correctly.');
                }

                // Create admin page instance
                console.log('üîê Creating admin page...');
                adminPage = new AdminPage();

                // Make globally accessible
                window.adminPage = adminPage;

                console.log('‚úÖ Admin Panel initialization complete');

            } catch (error) {
                console.error('‚ùå Admin Panel initialization failed:', error);
                showErrorBoundary(`Initialization failed: ${error.message}`);
            }
        }

        function waitForMasterInitializer(timeout = 30000) {
            return new Promise((resolve, reject) => {
                const startTime = Date.now();
                
                const checkInitializer = () => {
                    if (window.masterInitializer) {
                        resolve();
                    } else if (Date.now() - startTime > timeout) {
                        reject(new Error('Master initializer timeout'));
                    } else {
                        setTimeout(checkInitializer, 100);
                    }
                };
                
                checkInitializer();
            });
        }

        // Connect wallet function for admin access (CORS-free approach)
        async function connectWallet() {
            try {
                console.log('üîó Attempting wallet connection...');

                // Direct MetaMask connection (bypasses wallet manager issues)
                if (!window.ethereum) {
                    throw new Error('MetaMask not installed. Please install MetaMask to continue.');
                }

                console.log('ü¶ä Connecting directly to MetaMask...');

                // Request account access
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                if (!accounts || accounts.length === 0) {
                    throw new Error('No accounts found. Please unlock MetaMask.');
                }

                // Create provider and signer
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const signer = provider.getSigner();
                const address = await signer.getAddress();
                const network = await provider.getNetwork();

                console.log('‚úÖ Wallet connected successfully');
                console.log('üìç Address:', address);
                console.log('üåê Network:', network.chainId);

                // Store connection info globally
                window.walletConnection = {
                    provider,
                    signer,
                    address,
                    network,
                    isConnected: true
                };

                // Update wallet manager if available
                if (window.walletManager) {
                    window.walletManager.provider = provider;
                    window.walletManager.signer = signer;
                    window.walletManager.address = address;
                    window.walletManager.chainId = network.chainId;
                    console.log('üîÑ Updated wallet manager with connection info');
                }

                // Wait a moment for state to update
                await new Promise(resolve => setTimeout(resolve, 500));

                // Reinitialize admin panel after wallet connection
                if (adminPage) {
                    console.log('üîÑ Reinitializing admin panel...');
                    await adminPage.init();
                } else {
                    console.log('‚ö†Ô∏è Admin page not available, reloading...');
                    location.reload();
                }

            } catch (error) {
                console.error('‚ùå Wallet connection failed:', error);

                // Show user-friendly error message
                let errorMessage;
                if (error.message.includes('User rejected') || error.message.includes('User denied')) {
                    errorMessage = 'Wallet connection was cancelled by user';
                } else if (error.message.includes('not installed')) {
                    errorMessage = 'MetaMask not installed. Please install MetaMask extension.';
                } else if (error.message.includes('No accounts')) {
                    errorMessage = 'Please unlock MetaMask and try again.';
                } else {
                    errorMessage = `Wallet connection failed: ${error.message}`;
                }

                alert(errorMessage);
            }
        }

        // Auto-initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üìÑ DOM loaded, waiting for system initialization...');
            // Wait a bit for master initializer to complete
            setTimeout(() => {
                console.log('üîê Starting admin panel initialization...');

                // Check if all required classes are loaded
                const requiredClasses = ['AdminPage', 'ContractManager', 'WalletManager'];
                const missingClasses = requiredClasses.filter(className => typeof window[className] === 'undefined');

                if (missingClasses.length > 0) {
                    console.error('‚ùå Missing required classes:', missingClasses);

                    // Check if scripts are still loading
                    const scripts = document.querySelectorAll('script[src*="admin-page.js"], script[src*="contract-manager.js"], script[src*="wallet-manager.js"]');
                    console.log('üìú Script elements found:', scripts.length);

                    // Try a few more times with increasing delays
                    let retryCount = parseInt(sessionStorage.getItem('adminInitRetryCount') || '0');
                    if (retryCount < 3) {
                        sessionStorage.setItem('adminInitRetryCount', (retryCount + 1).toString());
                        console.log(`üîÑ Retry attempt ${retryCount + 1}/3 in ${(retryCount + 1) * 2} seconds...`);
                        setTimeout(initializeAdminPanel, (retryCount + 1) * 2000);
                    } else {
                        console.error('‚ùå Max retries reached. Script loading failed.');
                        showErrorBoundary('Failed to load required scripts. Please refresh the page.');
                        sessionStorage.removeItem('adminInitRetryCount');
                    }
                } else {
                    console.log('‚úÖ All required classes loaded');
                    sessionStorage.removeItem('adminInitRetryCount');
                    initializeAdminPanel();
                }
            }, 3000); // Give master initializer time to complete
        });

        // Network switcher function
        window.switchToPolygonAmoy = async function() {
            console.log('üîÑ Switching to Polygon Amoy...');

            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x13882' }], // 80002 in hex
                });
                console.log('‚úÖ Switched to Polygon Amoy');
                setTimeout(() => window.location.reload(), 1000);
            } catch (switchError) {
                if (switchError.code === 4902) {
                    // Network not added, add it
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0x13882',
                                chainName: 'Polygon Amoy Testnet',
                                nativeCurrency: {
                                    name: 'MATIC',
                                    symbol: 'MATIC',
                                    decimals: 18
                                },
                                rpcUrls: ['https://rpc-amoy.polygon.technology'],
                                blockExplorerUrls: ['https://amoy.polygonscan.com']
                            }]
                        });
                        console.log('‚úÖ Added and switched to Polygon Amoy');
                        setTimeout(() => window.location.reload(), 1000);
                    } catch (addError) {
                        console.error('‚ùå Failed to add network:', addError);
                        alert('‚ùå Failed to add Polygon Amoy network');
                    }
                } else {
                    console.error('‚ùå Failed to switch network:', switchError);
                    alert('‚ùå Failed to switch to Polygon Amoy');
                }
            }
        };

        // Z-index debugging function
        window.debugZIndex = function() {
            console.log('üîç Z-INDEX DEBUG: Checking all elements with high z-index...');

            const allElements = document.querySelectorAll('*');
            const highZElements = [];

            allElements.forEach(el => {
                const zIndex = window.getComputedStyle(el).zIndex;
                if (zIndex !== 'auto' && parseInt(zIndex) > 100) {
                    highZElements.push({
                        element: el.tagName + (el.id ? '#' + el.id : '') + (el.className ? '.' + el.className.split(' ').join('.') : ''),
                        zIndex: zIndex,
                        position: window.getComputedStyle(el).position
                    });
                }
            });

            console.log('üîç Elements with high z-index:', highZElements);

            // Check modal container specifically
            const modalContainer = document.getElementById('modal-container');
            if (modalContainer) {
                const style = window.getComputedStyle(modalContainer);
                console.log('üîç Modal container styles:', {
                    display: style.display,
                    zIndex: style.zIndex,
                    position: style.position,
                    opacity: style.opacity,
                    visibility: style.visibility
                });
            }
        };

        // Modal button visibility test
        window.testModalButtons = function() {
            console.log('üîç TESTING: Modal button visibility...');

            const modalContainer = document.getElementById('modal-container');
            if (!modalContainer) {
                console.error('‚ùå Modal container not found');
                return;
            }

            const modalFooter = modalContainer.querySelector('.modal-footer');
            const buttons = modalContainer.querySelectorAll('.modal-footer button');

            console.log('üîç Modal footer found:', !!modalFooter);
            console.log('üîç Buttons found:', buttons.length);

            if (modalFooter) {
                const footerStyle = window.getComputedStyle(modalFooter);
                console.log('üîç Modal footer styles:', {
                    display: footerStyle.display,
                    visibility: footerStyle.visibility,
                    opacity: footerStyle.opacity,
                    height: footerStyle.height,
                    position: footerStyle.position
                });
            }

            buttons.forEach((btn, index) => {
                const btnStyle = window.getComputedStyle(btn);
                console.log(`üîç Button ${index + 1}:`, {
                    text: btn.textContent.trim(),
                    display: btnStyle.display,
                    visibility: btnStyle.visibility,
                    opacity: btnStyle.opacity
                });
            });
        };

        // Test all admin modals
        window.testAllModals = function() {
            console.log('üß™ TESTING: All admin modals...');

            // First check if admin interface is loaded
            const adminContainer = document.querySelector('.admin-grid-main');
            if (!adminContainer) {
                console.log('‚ùå Admin interface not loaded yet. Wait a moment and try again.');
                return;
            }

            const modalTypes = [
                'hourly-rate',
                'add-pair',
                'remove-pair',
                'update-weights',
                'change-signer',
                'withdraw-rewards'
            ];

            // Check all buttons exist first
            console.log('üîç Checking button availability...');
            modalTypes.forEach(type => {
                const button = document.querySelector(`[data-modal="${type}"]`);
                console.log(`üîç Button [data-modal="${type}"]:`, button ? '‚úÖ Found' : '‚ùå Not found');
            });

            modalTypes.forEach((type, index) => {
                setTimeout(() => {
                    console.log(`üß™ Testing modal: ${type}`);

                    // Simulate button click
                    const button = document.querySelector(`[data-modal="${type}"]`);
                    if (button) {
                        console.log(`‚úÖ Clicking button for: ${type}`);
                        button.click();

                        setTimeout(() => {
                            const modal = document.getElementById('modal-container');
                            const buttons = modal ? modal.querySelectorAll('.modal-footer button') : [];
                            console.log(`‚úÖ ${type} modal: ${buttons.length} buttons found`);

                            // Log button details
                            buttons.forEach((btn, btnIndex) => {
                                console.log(`  Button ${btnIndex + 1}: "${btn.textContent.trim()}"`);
                            });

                            // Close modal
                            if (modal) {
                                modal.style.display = 'none';
                                modal.innerHTML = '';
                            }
                        }, 800);
                    } else {
                        console.log(`‚ùå Button not found for: ${type}`);
                        // Try alternative selector
                        const altButton = document.querySelector(`.proposal-btn:contains("${type}")`);
                        console.log(`üîç Alternative search result:`, altButton ? '‚úÖ Found' : '‚ùå Not found');
                    }
                }, index * 1500);
            });
        };

        // Test individual modal
        window.testModal = function(modalType) {
            console.log(`üß™ Testing individual modal: ${modalType}`);

            const button = document.querySelector(`[data-modal="${modalType}"]`);
            if (button) {
                console.log(`‚úÖ Found button for: ${modalType}`);
                button.click();

                setTimeout(() => {
                    const modal = document.getElementById('modal-container');
                    const buttons = modal ? modal.querySelectorAll('.modal-footer button') : [];
                    const footer = modal ? modal.querySelector('.modal-footer') : null;

                    console.log(`üìä Modal Results for ${modalType}:`);
                    console.log(`  - Modal container: ${modal ? '‚úÖ Found' : '‚ùå Not found'}`);
                    console.log(`  - Modal footer: ${footer ? '‚úÖ Found' : '‚ùå Not found'}`);
                    console.log(`  - Footer buttons: ${buttons.length}`);

                    if (footer) {
                        const footerStyle = window.getComputedStyle(footer);
                        console.log(`  - Footer display: ${footerStyle.display}`);
                        console.log(`  - Footer visibility: ${footerStyle.visibility}`);
                        console.log(`  - Footer opacity: ${footerStyle.opacity}`);
                    }

                    buttons.forEach((btn, index) => {
                        const btnStyle = window.getComputedStyle(btn);
                        console.log(`  - Button ${index + 1}: "${btn.textContent.trim()}" (display: ${btnStyle.display}, visibility: ${btnStyle.visibility})`);
                    });
                }, 1000);
            } else {
                console.log(`‚ùå Button not found for: ${modalType}`);
                console.log('Available buttons:');
                document.querySelectorAll('.proposal-btn').forEach(btn => {
                    console.log(`  - ${btn.textContent.trim()} [data-modal="${btn.dataset.modal}"]`);
                });
            }
        };

        // Test cancel buttons
        window.testCancelButtons = function() {
            console.log('üß™ Testing cancel button functionality...');

            const modalTypes = ['hourly-rate', 'add-pair', 'remove-pair', 'update-weights', 'change-signer', 'withdraw-rewards'];

            modalTypes.forEach((type, index) => {
                setTimeout(() => {
                    console.log(`üß™ Testing cancel for: ${type}`);

                    // Open modal
                    const button = document.querySelector(`[data-modal="${type}"]`);
                    if (button) {
                        button.click();

                        setTimeout(() => {
                            // Find and test cancel button
                            const modal = document.getElementById('modal-container');
                            const cancelBtn = modal ? modal.querySelector('.btn-secondary, .modal-cancel') : null;

                            if (cancelBtn) {
                                console.log(`‚úÖ Cancel button found for ${type}:`, cancelBtn.textContent.trim());
                                console.log(`  - Classes: ${cancelBtn.className}`);
                                console.log(`  - OnClick: ${cancelBtn.getAttribute('onclick')}`);

                                // Test click
                                cancelBtn.click();

                                setTimeout(() => {
                                    const modalAfter = document.getElementById('modal-container');
                                    const isHidden = !modalAfter || modalAfter.style.display === 'none' || modalAfter.innerHTML === '';
                                    console.log(`  - Cancel worked: ${isHidden ? '‚úÖ YES' : '‚ùå NO'}`);
                                }, 200);
                            } else {
                                console.log(`‚ùå Cancel button not found for: ${type}`);
                            }
                        }, 500);
                    }
                }, index * 2000);
            });
        };

        // Add Polygon Amoy network to MetaMask
        window.addPolygonAmoyNetwork = async function() {
            console.log('üîß Adding Polygon Amoy network to MetaMask...');

            try {
                // First try to switch to existing network
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x13882' }] // 80002 in hex
                });
                console.log('‚úÖ Switched to existing Polygon Amoy network');
            } catch (switchError) {
                // If network doesn't exist, add it
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0x13882', // 80002 in hex
                                chainName: 'Polygon Amoy Testnet',
                                nativeCurrency: {
                                    name: 'MATIC',
                                    symbol: 'MATIC',
                                    decimals: 18
                                },
                                rpcUrls: [
                                    'https://rpc-amoy.polygon.technology',
                                    'https://polygon-amoy-bor-rpc.publicnode.com'
                                ],
                                blockExplorerUrls: ['https://amoy.polygonscan.com']
                            }]
                        });
                        console.log('‚úÖ Polygon Amoy network added successfully');
                    } catch (addError) {
                        console.error('‚ùå Failed to add Polygon Amoy network:', addError);
                    }
                } else {
                    console.log('‚úÖ Network already exists, switch successful');
                }
            }
        };

        // Switch to Polygon Amoy network
        window.switchToPolygonAmoy = async function() {
            console.log('üîß Switching to Polygon Amoy network...');

            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x13882' }] // 80002 in hex
                });
                console.log('‚úÖ Switched to Polygon Amoy network');
            } catch (error) {
                if (error.code === 4902) {
                    // Network not added, add it first
                    await addPolygonAmoyNetwork();
                } else {
                    console.error('‚ùå Failed to switch network:', error);
                }
            }
        };

        // Debug form validation directly
        window.debugFormValidation = function() {
            console.log('üîß DEBUG: Testing form validation...');

            // Check if modal is open
            const modal = document.getElementById('modal-container');
            console.log('Modal container:', modal);
            console.log('Modal display:', modal ? modal.style.display : 'N/A');
            console.log('Modal innerHTML length:', modal ? modal.innerHTML.length : 0);

            // Check for forms
            const allForms = document.querySelectorAll('form');
            console.log('All forms in document:', allForms.length);
            allForms.forEach((form, index) => {
                console.log(`Form ${index + 1}:`, {
                    id: form.id,
                    classes: form.className,
                    parent: form.parentElement?.tagName,
                    visible: form.offsetParent !== null
                });
            });

            // Try to find add-pair-form specifically
            const addPairForm = document.getElementById('add-pair-form');
            console.log('add-pair-form found:', !!addPairForm);
            if (addPairForm) {
                console.log('Form details:', {
                    id: addPairForm.id,
                    visible: addPairForm.offsetParent !== null,
                    inputs: addPairForm.querySelectorAll('input, select, textarea').length
                });
            }
        };

        // Test form submission directly
        window.testFormSubmission = function() {
            console.log('üîß Testing form submission...');

            // Open add pair modal first
            const addPairBtn = document.querySelector('[data-modal="add-pair"]');
            if (addPairBtn) {
                console.log('Opening add pair modal...');
                addPairBtn.click();

                setTimeout(() => {
                    debugFormValidation();

                    // Try to submit form
                    const form = document.getElementById('add-pair-form');
                    if (form) {
                        console.log('Attempting to submit form...');
                        const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                        form.dispatchEvent(submitEvent);
                    }
                }, 1000);
            }
        };

        // Test contract function directly
        window.testContractFunction = async function() {
            console.log('üîß Testing contract function directly...');

            try {
                // Get contract manager
                const contractManager = window.contractManager;
                if (!contractManager) {
                    console.error('‚ùå Contract manager not available');
                    return;
                }

                console.log('üîß Contract manager found, testing proposeAddPair...');

                // Test the proposeAddPair function
                const result = await contractManager.proposeAddPair(
                    '0x1234567890123456789012345678901234567890',
                    'TEST/USDC',
                    'Uniswap V3',
                    100,
                    'Test description'
                );

                console.log('‚úÖ Contract function result:', result);

                if (result.success) {
                    console.log('üéâ Mock transaction successful!');
                    console.log('üìã Transaction hash:', result.transactionHash);
                } else {
                    console.log('‚ùå Contract function failed:', result.error);
                }

            } catch (error) {
                console.error('‚ùå Test failed:', error);
            }
        };

        // Debug proposal system
        window.debugProposals = function() {
            console.log('üîß DEBUG: Testing proposal system...');

            if (!window.adminPage) {
                console.error('‚ùå AdminPage not available');
                return;
            }

            console.log('üîß AdminPage found, checking mock proposals...');
            console.log('Mock proposals map:', window.adminPage.mockProposals);
            console.log('Mock proposals size:', window.adminPage.mockProposals.size);

            // Test getMockProposals
            const mockProposals = window.adminPage.getMockProposals();
            console.log('Mock proposals array:', mockProposals);

            // Test loadMockProposals
            const formattedProposals = window.adminPage.loadMockProposals();
            console.log('Formatted proposals:', formattedProposals);

            // Force reload proposals
            console.log('üîß Force reloading proposals...');
            window.adminPage.loadMultiSignPanel();
        };

        // Test mock system initialization
        window.testMockSystem = function() {
            console.log('üîß Testing mock system initialization...');

            if (!window.adminPage) {
                console.error('‚ùå AdminPage not available');
                return;
            }

            // Manually initialize mock system
            window.adminPage.initializeMockSystem();
            console.log('‚úÖ Mock system initialized');

            // Debug the results
            debugProposals();
        };

        // Test ADD PAIR functionality
        window.testAddPair = async function() {
            console.log('üß™ Testing ADD PAIR functionality...');

            if (!window.adminPage) {
                console.error('‚ùå AdminPage not available');
                return;
            }

            try {
                // Get contract manager
                const contractManager = window.contractManager;
                if (!contractManager) {
                    console.error('‚ùå Contract manager not available');
                    return;
                }

                console.log('üîß Contract manager found, testing proposeAddPair...');

                // Test the proposeAddPair function
                const result = await contractManager.proposeAddPair(
                    '0x1234567890123456789012345678901234567890',
                    'TEST/USDC',
                    'Uniswap V3',
                    100
                );

                console.log('‚úÖ Contract function result:', result);

                if (result.success) {
                    console.log('üéâ Proposal creation successful!');
                    console.log('üìã Transaction hash:', result.transactionHash);

                    // Refresh the admin panel to show new proposal
                    await window.adminPage.refreshData();
                    console.log('‚úÖ Admin panel refreshed');
                } else {
                    console.log('‚ùå Contract function failed:', result.error);
                }

            } catch (error) {
                console.error('‚ùå Test failed:', error);
            }
        };

        // Test real contract governance functions
        window.testRealContract = async function() {
            console.log('üß™ Testing REAL CONTRACT governance functions...');

            try {
                const contractManager = window.contractManager;
                if (!contractManager) {
                    console.error('‚ùå Contract manager not available');
                    return;
                }

                console.log('üîß Testing contract functions...');

                // Test 1: Check actionCounter
                try {
                    const actionCounter = await contractManager.stakingContract.actionCounter();
                    console.log('‚úÖ actionCounter:', actionCounter.toString());
                } catch (error) {
                    console.error('‚ùå actionCounter failed:', error.message);
                }

                // Test 2: Check REQUIRED_APPROVALS
                try {
                    const requiredApprovals = await contractManager.stakingContract.REQUIRED_APPROVALS();
                    console.log('‚úÖ REQUIRED_APPROVALS:', requiredApprovals.toString());
                } catch (error) {
                    console.error('‚ùå REQUIRED_APPROVALS failed:', error.message);
                }

                // Test 3: Check if approveAction function exists
                try {
                    const hasApproveAction = typeof contractManager.stakingContract.approveAction === 'function';
                    console.log('‚úÖ approveAction function exists:', hasApproveAction);
                } catch (error) {
                    console.error('‚ùå approveAction check failed:', error.message);
                }

                // Test 4: Check if rejectAction function exists
                try {
                    const hasRejectAction = typeof contractManager.stakingContract.rejectAction === 'function';
                    console.log('‚úÖ rejectAction function exists:', hasRejectAction);
                } catch (error) {
                    console.error('‚ùå rejectAction check failed:', error.message);
                }

                // Test 5: Check if proposeAddPair function exists
                try {
                    const hasProposeAddPair = typeof contractManager.stakingContract.proposeAddPair === 'function';
                    console.log('‚úÖ proposeAddPair function exists:', hasProposeAddPair);
                } catch (error) {
                    console.error('‚ùå proposeAddPair check failed:', error.message);
                }

                console.log('üéâ Real contract test completed!');

            } catch (error) {
                console.error('‚ùå Real contract test failed:', error);
            }
        };

        // Test wallet and signer status
        window.testWalletSigner = async function() {
            console.log('üß™ Testing WALLET AND SIGNER status...');

            try {
                // Test 1: Check wallet manager
                if (window.walletManager) {
                    console.log('‚úÖ Wallet manager exists');
                    console.log('üîç Wallet connected:', window.walletManager.isConnected());
                    console.log('üîç Wallet address:', window.walletManager.getAddress());
                    console.log('üîç Wallet type:', window.walletManager.getWalletType());
                    console.log('üîç Chain ID:', window.walletManager.getChainId());
                } else {
                    console.error('‚ùå Wallet manager not found');
                }

                // Test 2: Check contract manager
                if (window.contractManager) {
                    console.log('‚úÖ Contract manager exists');
                    console.log('üîç Contract manager ready:', window.contractManager.isReady());
                    console.log('üîç Has provider:', !!window.contractManager.provider);
                    console.log('üîç Has signer:', !!window.contractManager.signer);

                    // Test signer
                    if (window.contractManager.signer) {
                        try {
                            const signerAddress = await window.contractManager.signer.getAddress();
                            console.log('‚úÖ Signer address:', signerAddress);
                        } catch (error) {
                            console.error('‚ùå Signer address failed:', error.message);
                        }
                    } else {
                        console.warn('‚ö†Ô∏è No signer available');
                    }
                } else {
                    console.error('‚ùå Contract manager not found');
                }

                // Test 3: Check MetaMask
                if (window.ethereum) {
                    console.log('‚úÖ MetaMask available');
                    try {
                        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                        console.log('üîç MetaMask accounts:', accounts);
                    } catch (error) {
                        console.error('‚ùå MetaMask accounts failed:', error.message);
                    }
                } else {
                    console.error('‚ùå MetaMask not available');
                }

                console.log('üéâ Wallet/Signer test completed!');

            } catch (error) {
                console.error('‚ùå Wallet/Signer test failed:', error);
            }
        };

        // Force fix signer issue
        window.fixSigner = async function() {
            console.log('üîß FIXING SIGNER ISSUE...');

            try {
                if (!window.contractManager) {
                    console.error('‚ùå Contract manager not found');
                    return;
                }

                // Force get signer from MetaMask
                if (window.ethereum) {
                    console.log('üîß Getting signer from MetaMask...');
                    const provider = new ethers.providers.Web3Provider(window.ethereum);
                    const signer = provider.getSigner();

                    // Verify signer works
                    const address = await signer.getAddress();
                    console.log('‚úÖ Signer address:', address);

                    // Update contract manager
                    window.contractManager.provider = provider;
                    window.contractManager.signer = signer;

                    // Reinitialize contracts with signer
                    await window.contractManager.initializeContracts();
                    console.log('‚úÖ Contract manager updated with signer');

                    // Test signer again
                    await testWalletSigner();

                } else {
                    console.error('‚ùå MetaMask not available');
                }

            } catch (error) {
                console.error('‚ùå Fix signer failed:', error);
            }
        };

        // Complete system fix
        window.fixEverything = async function() {
            console.log('üîß FIXING ALL SYSTEM ISSUES...');

            try {
                // Step 1: Fix signer
                console.log('üîß Step 1: Fixing signer...');
                await fixSigner();

                // Step 2: Test contract functions
                console.log('üîß Step 2: Testing contract functions...');
                await testRealContract();

                // Step 3: Refresh admin panel
                console.log('üîß Step 3: Refreshing admin panel...');
                if (window.adminPage) {
                    await window.adminPage.refreshData();
                }

                console.log('üéâ SYSTEM FIX COMPLETED!');
                console.log('‚úÖ Try the ADD PAIR button now');

            } catch (error) {
                console.error('‚ùå System fix failed:', error);
            }
        };

        // Test contract signer integration
        window.testContractSigner = async function() {
            console.log('üß™ Testing CONTRACT SIGNER integration...');

            try {
                const contractManager = window.contractManager;
                if (!contractManager) {
                    console.error('‚ùå Contract manager not found');
                    return;
                }

                // Test 1: Check if contracts have signer
                console.log('üîç Staking contract signer:', !!contractManager.stakingContract?.signer);
                console.log('üîç Reward token contract signer:', !!contractManager.rewardTokenContract?.signer);

                // Test 2: Force ensure signer
                console.log('üîß Ensuring signer...');
                await contractManager.ensureSigner();

                // Test 3: Check contracts again
                console.log('üîç After ensureSigner - Staking contract signer:', !!contractManager.stakingContract?.signer);
                console.log('üîç After ensureSigner - Reward token contract signer:', !!contractManager.rewardTokenContract?.signer);

                // Test 4: Try to get signer address from contract
                if (contractManager.stakingContract?.signer) {
                    try {
                        const signerAddress = await contractManager.stakingContract.signer.getAddress();
                        console.log('‚úÖ Contract signer address:', signerAddress);
                    } catch (error) {
                        console.error('‚ùå Contract signer address failed:', error.message);
                    }
                }

                console.log('üéâ Contract signer test completed!');

            } catch (error) {
                console.error('‚ùå Contract signer test failed:', error);
            }
        };

        // Ultimate fix for all signer issues
        window.ultimateSignerFix = async function() {
            console.log('üîß ULTIMATE SIGNER FIX - Fixing all issues...');

            try {
                const contractManager = window.contractManager;
                if (!contractManager) {
                    console.error('‚ùå Contract manager not found');
                    return;
                }

                // Step 1: Force get signer from MetaMask
                console.log('üîß Step 1: Getting signer from MetaMask...');
                if (!window.ethereum) {
                    console.error('‚ùå MetaMask not available');
                    return;
                }

                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const signer = provider.getSigner();

                // Verify signer works
                const address = await signer.getAddress();
                console.log('‚úÖ Signer address:', address);

                // Step 2: Update contract manager
                console.log('üîß Step 2: Updating contract manager...');
                contractManager.provider = provider;
                contractManager.signer = signer;

                // Step 3: Recreate all contracts with signer
                console.log('üîß Step 3: Recreating contracts with signer...');
                await contractManager.initializeContracts();

                // Step 4: Verify contracts have signer
                console.log('üîß Step 4: Verifying contracts...');
                console.log('‚úÖ Staking contract has signer:', !!contractManager.stakingContract?.signer);
                console.log('‚úÖ Reward token contract has signer:', !!contractManager.rewardTokenContract?.signer);

                // Step 5: Test a simple contract call
                console.log('üîß Step 5: Testing contract call...');
                try {
                    const rewardToken = await contractManager.stakingContract.rewardToken();
                    console.log('‚úÖ Contract call successful, reward token:', rewardToken);
                } catch (error) {
                    console.log('‚ö†Ô∏è Contract call failed (might be network issue):', error.message);
                }

                console.log('üéâ ULTIMATE SIGNER FIX COMPLETED!');
                console.log('‚úÖ Try the ADD PAIR or HOURLY RATE buttons now');

            } catch (error) {
                console.error('‚ùå Ultimate signer fix failed:', error);
            }
        };

        // Test proposal creation with error handling
        window.testProposalCreation = async function() {
            console.log('üß™ Testing PROPOSAL CREATION with error handling...');

            try {
                const contractManager = window.contractManager;
                if (!contractManager) {
                    console.error('‚ùå Contract manager not found');
                    return;
                }

                // Test 1: Test add pair proposal
                console.log('üîß Testing add pair proposal...');
                const addPairResult = await contractManager.proposeAddPair(
                    '0x1234567890123456789012345678901234567890',
                    'TEST/USDC',
                    'Uniswap V3',
                    100,
                    'Test proposal'
                );

                console.log('‚úÖ Add pair result:', addPairResult);

                if (addPairResult.success) {
                    if (addPairResult.isDemo) {
                        console.log('‚úÖ Demo proposal created successfully');
                        console.log('   - Message:', addPairResult.message);
                        console.log('   - Transaction Hash:', addPairResult.transactionHash);
                    } else {
                        console.log('‚úÖ Real proposal created successfully');
                        console.log('   - Transaction Hash:', addPairResult.transactionHash);
                    }
                } else {
                    console.error('‚ùå Add pair proposal failed:', addPairResult.error);
                }

                // Test 2: Test hourly rate proposal
                console.log('üîß Testing hourly rate proposal...');
                const hourlyRateResult = await contractManager.proposeSetHourlyRewardRate(0.1);

                console.log('‚úÖ Hourly rate result:', hourlyRateResult);

                if (hourlyRateResult.success) {
                    if (hourlyRateResult.isDemo) {
                        console.log('‚úÖ Demo hourly rate proposal created successfully');
                        console.log('   - Message:', hourlyRateResult.message);
                        console.log('   - Transaction Hash:', hourlyRateResult.transactionHash);
                    } else {
                        console.log('‚úÖ Real hourly rate proposal created successfully');
                        console.log('   - Transaction Hash:', hourlyRateResult.transactionHash);
                    }
                } else {
                    console.error('‚ùå Hourly rate proposal failed:', hourlyRateResult.error);
                }

                console.log('üéâ Proposal creation test completed!');

            } catch (error) {
                console.error('‚ùå Proposal creation test failed:', error);
            }
        };

        // Complete system test
        window.completeSystemTest = async function() {
            console.log('üß™ COMPLETE SYSTEM TEST - Testing everything...');

            try {
                // Step 1: Test wallet and signer
                console.log('üîß Step 1: Testing wallet and signer...');
                await testWalletSigner();

                // Step 2: Test contract signer integration
                console.log('üîß Step 2: Testing contract signer integration...');
                await testContractSigner();

                // Step 3: Test proposal creation
                console.log('üîß Step 3: Testing proposal creation...');
                await testProposalCreation();

                // Step 4: Test forms
                console.log('üîß Step 4: Forms should now work - try the ADD PAIR and HOURLY RATE buttons!');
                console.log('‚úÖ COMPLETE SYSTEM TEST PASSED!');
                console.log('üéâ The system is ready for demo use!');

            } catch (error) {
                console.error('‚ùå Complete system test failed:', error);
            }
        };

        // Test the actual forms like React version
        window.testFormsLikeReact = async function() {
            console.log('üß™ Testing forms with React-like patterns...');

            try {
                // Test 1: Test hourly rate form
                console.log('üîß Testing hourly rate form...');

                // Fill form fields
                const rateInput = document.getElementById('new-rate');
                const descInput = document.getElementById('rate-description');

                if (rateInput && descInput) {
                    rateInput.value = '0.5';
                    descInput.value = 'Test hourly rate proposal';

                    // Simulate form submission
                    const result = await window.adminPage.submitHourlyRateProposal({preventDefault: () => {}});
                    console.log('‚úÖ Hourly rate form test result:', result);
                } else {
                    console.log('‚ö†Ô∏è Hourly rate form fields not found - open the modal first');
                }

                // Test 2: Test add pair form
                console.log('üîß Testing add pair form...');

                const pairAddressInput = document.getElementById('pair-address');
                const pairNameInput = document.getElementById('pair-name');
                const pairPlatformInput = document.getElementById('pair-platform');
                const pairWeightInput = document.getElementById('pair-weight');
                const pairDescInput = document.getElementById('pair-description');

                if (pairAddressInput && pairNameInput && pairPlatformInput && pairWeightInput) {
                    pairAddressInput.value = '0x1234567890123456789012345678901234567890';
                    pairNameInput.value = 'TEST/USDC';
                    pairPlatformInput.value = 'Uniswap V3';
                    pairWeightInput.value = '100';
                    if (pairDescInput) pairDescInput.value = 'Test add pair proposal';

                    // Simulate form submission
                    const result = await window.adminPage.submitAddPairProposal({preventDefault: () => {}});
                    console.log('‚úÖ Add pair form test result:', result);
                } else {
                    console.log('‚ö†Ô∏è Add pair form fields not found - open the modal first');
                }

                console.log('üéâ Form testing completed!');
                console.log('‚úÖ Both forms should now work without errors');

            } catch (error) {
                console.error('‚ùå Form testing failed:', error);
            }
        };

        // Test proposal loading specifically
        window.testProposalLoading = async function() {
            console.log('üß™ Testing proposal loading like React version...');

            try {
                const contractManager = await window.adminPage.ensureContractReady();

                // Test 1: Get action counter
                console.log('üîß Testing getActionCounter...');
                const actionCounter = await contractManager.getActionCounter();
                console.log('‚úÖ Action counter:', actionCounter);

                // Test 2: Try to get actions (like React version)
                console.log('üîß Testing getAction calls...');
                for (let i = actionCounter; i >= Math.max(1, actionCounter - 5); i--) {
                    console.log(`üîß Testing getAction(${i})...`);
                    const action = await contractManager.getAction(i);
                    if (action) {
                        console.log(`‚úÖ Action ${i}:`, {
                            actionType: action.actionType,
                            executed: action.executed,
                            approvals: action.approvals
                        });
                    } else {
                        console.log(`‚ö†Ô∏è Action ${i}: null (gracefully handled)`);
                    }
                }

                // Test 3: Load proposals through admin page
                console.log('üîß Testing loadProposals...');
                const proposals = await window.adminPage.loadProposals();
                console.log('‚úÖ Loaded proposals:', proposals.length);
                proposals.forEach(p => {
                    console.log(`  - Proposal ${p.id}: ${p.actionType} (${p.approvals}/${p.requiredApprovals} approvals)`);
                });

                // Test 4: Check if proposals show in UI
                console.log('üîß Checking UI display...');
                const proposalRows = document.querySelectorAll('.proposal-row');
                console.log(`‚úÖ Found ${proposalRows.length} proposal rows in UI`);

                console.log('üéâ Proposal loading test completed!');

            } catch (error) {
                console.error('‚ùå Proposal loading test failed:', error);
            }
        };

        // Test RPC health and fallback system
        window.testRpcHealthAndFallbacks = async function() {
            console.log('üß™ Testing RPC health and fallback system...');

            try {
                const contractManager = await window.adminPage.ensureContractReady();

                // Test 1: Check RPC health
                console.log('üîß Testing RPC health check...');
                const isRpcDown = await window.adminPage.checkRpcHealth(contractManager);
                console.log('‚úÖ RPC health check result:', isRpcDown ? 'DOWN (using fallbacks)' : 'HEALTHY');

                // Test 2: Test safe contract calls
                console.log('üîß Testing safe contract calls...');
                const rewardToken = await window.adminPage.safeContractCall(
                    () => contractManager.stakingContract.rewardToken(),
                    'FALLBACK_TOKEN'
                );
                console.log('‚úÖ Safe rewardToken call:', rewardToken);

                const actionCounter = await window.adminPage.safeContractCall(
                    () => contractManager.stakingContract.actionCounter(),
                    999
                );
                console.log('‚úÖ Safe actionCounter call:', actionCounter);

                // Test 3: Test demo proposals
                console.log('üîß Testing demo proposals...');
                const demoProposals = window.adminPage.createDemoProposals();
                console.log('‚úÖ Demo proposals created:', demoProposals.length);
                demoProposals.forEach(p => {
                    console.log(`  - Demo Proposal ${p.id}: ${p.actionType} (${p.approvals}/${p.requiredApprovals} approvals)`);
                });

                // Test 4: Test contract stats loading
                console.log('üîß Testing contract stats loading...');
                await window.adminPage.loadContractStats();
                console.log('‚úÖ Contract stats loaded with fallbacks');

                // Test 5: Test proposal loading
                console.log('üîß Testing proposal loading with fallbacks...');
                const proposals = await window.adminPage.loadProposals();
                console.log('‚úÖ Proposals loaded:', proposals.length);
                proposals.forEach(p => {
                    console.log(`  - Proposal ${p.id}: ${p.actionType} (${p.approvals}/${p.requiredApprovals} approvals)`);
                });

                console.log('üéâ RPC health and fallback test completed!');
                console.log('‚úÖ System handles RPC issues gracefully like React version');

            } catch (error) {
                console.error('‚ùå RPC health test failed:', error);
            }
        };

        // Test the complete admin panel with fallbacks
        window.testAdminPanelWithFallbacks = async function() {
            console.log('üß™ Testing complete admin panel with fallbacks...');

            try {
                // Test 1: Load contract stats
                console.log('üîß Testing contract stats loading...');
                await window.adminPage.loadContractStats();
                console.log('‚úÖ Contract stats loaded');

                // Test 2: Load proposals with fallbacks
                console.log('üîß Testing proposal loading with fallbacks...');
                const proposals = await window.adminPage.loadProposals();
                console.log('‚úÖ Proposals loaded:', proposals.length);

                if (proposals.length === 0) {
                    console.log('‚ö†Ô∏è No real proposals loaded, forcing demo proposals...');
                    const demoProposals = window.adminPage.createDemoProposals();
                    console.log('‚úÖ Demo proposals created:', demoProposals.length);

                    // Manually display demo proposals
                    window.adminPage.displayProposals(demoProposals);
                    console.log('‚úÖ Demo proposals displayed in UI');
                }

                // Test 3: Check UI elements
                console.log('üîß Checking UI elements...');
                const proposalRows = document.querySelectorAll('.proposal-row, .proposal-item');
                console.log(`‚úÖ Found ${proposalRows.length} proposal elements in UI`);

                const approveButtons = document.querySelectorAll('[data-action="approve"], .approve-btn');
                const rejectButtons = document.querySelectorAll('[data-action="reject"], .reject-btn');
                console.log(`‚úÖ Found ${approveButtons.length} approve buttons and ${rejectButtons.length} reject buttons`);

                console.log('üéâ Admin panel test completed!');
                console.log('‚úÖ System shows proposals even when contract calls fail');

            } catch (error) {
                console.error('‚ùå Admin panel test failed:', error);
            }
        };

        // Test the complete governance system like React version
        window.testCompleteGovernanceSystem = async function() {
            console.log('üß™ Testing complete governance system like React version...');

            try {
                // Test 1: Load contract information
                console.log('üîß Testing contract information loading...');
                await window.adminPage.loadContractInformation();
                console.log('‚úÖ Contract information loaded');

                // Test 2: Check current signer
                console.log('üîß Testing signer detection...');
                try {
                    const contractManager = await window.adminPage.ensureContractReady();
                    const currentSigner = await contractManager.getCurrentSigner();
                    console.log('‚úÖ Current signer:', currentSigner);
                } catch (error) {
                    console.log('‚ö†Ô∏è Signer detection failed (expected with RPC issues):', error.message);
                }

                // Test 3: Load proposals with proper error handling
                console.log('üîß Testing proposal loading with error handling...');
                const proposals = await window.adminPage.loadProposals();
                console.log('‚úÖ Proposals loaded:', proposals.length);

                // Test 4: Check UI elements
                console.log('üîß Testing UI elements...');
                const rewardBalanceEl = document.querySelector('[data-info="reward-balance"]');
                const hourlyRateEl = document.querySelector('[data-info="hourly-rate"]');
                const pairsEl = document.querySelector('[data-info="lp-pairs"]');
                const signersEl = document.querySelector('[data-info="signers"]');

                console.log('‚úÖ UI Elements found:', {
                    rewardBalance: !!rewardBalanceEl,
                    hourlyRate: !!hourlyRateEl,
                    pairs: !!pairsEl,
                    signers: !!signersEl
                });

                // Test 5: Test voting error handling
                console.log('üîß Testing voting error handling...');
                console.log('‚ÑπÔ∏è Try clicking approve/reject buttons to see proper error messages');

                console.log('üéâ Complete governance system test completed!');
                console.log('‚úÖ System shows real contract data and handles errors gracefully');
                console.log('‚úÖ Voting buttons show proper error messages for already voted proposals');
                console.log('‚úÖ Contract information panel displays real data from blockchain');

            } catch (error) {
                console.error('‚ùå Complete governance system test failed:', error);
            }
        };

        // Test error handling specifically
        window.testErrorHandling = async function() {
            console.log('üß™ Testing error handling for voting...');

            try {
                // Test the error extraction logic
                const testError = {
                    technicalMessage: 'cannot estimate gas; transaction may fail or may require manual gas limit (reason="execution reverted: Already approved")',
                    message: 'UNPREDICTABLE_GAS_LIMIT'
                };

                console.log('üîß Testing error message extraction...');

                // Simulate the error handling logic
                let errorMessage = '';
                if (testError.technicalMessage) {
                    errorMessage = testError.technicalMessage;
                } else if (testError.message) {
                    errorMessage = testError.message;
                }

                console.log('‚úÖ Extracted error message:', errorMessage);

                if (errorMessage.includes('Already approved') || errorMessage.includes('execution reverted: Already approved')) {
                    console.log('‚úÖ Would show: "You have already approved this proposal. Each signer can only vote once per proposal."');
                } else if (errorMessage.includes('Cannot reject after approving')) {
                    console.log('‚úÖ Would show: "You cannot reject a proposal you have already approved."');
                } else if (errorMessage.includes('UNPREDICTABLE_GAS_LIMIT')) {
                    console.log('‚úÖ Would show: "Transaction would fail. You may have already voted on this proposal."');
                }

                console.log('üéâ Error handling test completed!');
                console.log('‚úÖ The system will now show user-friendly error messages instead of technical errors');

            } catch (error) {
                console.error('‚ùå Error handling test failed:', error);
            }
        };

        // Test the new voting system with proper error handling
        window.testVotingWithErrorHandling = async function() {
            console.log('üß™ Testing voting system with new error handling...');

            try {
                console.log('üîß Testing approve action error handling...');

                // Try to approve a proposal (this should show user-friendly error)
                console.log('‚ÑπÔ∏è Click an approve button to test the new error handling');
                console.log('‚úÖ Expected behavior:');
                console.log('   - If already approved: "‚úã You have already approved this proposal. Each signer can only vote once per proposal."');
                console.log('   - If successful: "‚úÖ Proposal approved successfully! Your vote has been recorded on the blockchain."');

                console.log('üîß Testing reject action error handling...');
                console.log('‚ÑπÔ∏è Click a reject button to test the new error handling');
                console.log('‚úÖ Expected behavior:');
                console.log('   - If cannot reject after approving: "‚úã You cannot reject a proposal you have already approved. Each signer can only vote once per proposal."');
                console.log('   - If successful: "‚úÖ Proposal rejected successfully! Your vote has been recorded on the blockchain."');

                console.log('üéâ Voting system test setup completed!');
                console.log('‚úÖ The system now returns proper success/error objects instead of throwing exceptions');
                console.log('‚úÖ User-friendly error messages will be displayed instead of technical errors');

            } catch (error) {
                console.error('‚ùå Voting system test failed:', error);
            }
        };

        // Test the new React-like proposal loading
        window.testReactLikeProposalLoading = async function() {
            console.log('üß™ Testing React-like proposal loading...');

            try {
                console.log('üîß Testing contract manager functions...');

                const contractManager = await window.adminPage.ensureContractReady();

                // Test all the new functions
                console.log('üìä Testing getActionCounter...');
                const actionCounter = await contractManager.getActionCounter();
                console.log('‚úÖ Action counter:', actionCounter);

                console.log('üìä Testing getRequiredApprovals...');
                const requiredApprovals = await contractManager.getRequiredApprovals();
                console.log('‚úÖ Required approvals:', requiredApprovals);

                console.log('üìä Testing getSigners...');
                const signers = await contractManager.getSigners();
                console.log('‚úÖ Signers:', signers.length, 'addresses');

                console.log('üìä Testing getTotalWeight...');
                const totalWeight = await contractManager.getTotalWeight();
                console.log('‚úÖ Total weight:', totalWeight.toString());

                console.log('üìä Testing getPairs...');
                const pairs = await contractManager.getPairs();
                console.log('‚úÖ Pairs:', pairs.length, 'pairs');

                // Test loading proposals like React version
                if (actionCounter > 0) {
                    console.log('üìã Testing React-like proposal loading...');

                    for (let i = actionCounter; i > Math.max(actionCounter - 3, 0); i--) {
                        console.log(`üìã Loading action ${i}...`);

                        const proposal = await contractManager.getActions(i);
                        const pairs = await contractManager.getActionPairs(i);
                        const weights = await contractManager.getActionWeights(i);

                        if (proposal && !Array.isArray(proposal)) {
                            console.log(`‚úÖ Action ${i}:`, {
                                actionType: proposal.actionType,
                                executed: proposal.executed,
                                approvals: proposal.approvals,
                                pairs: pairs.length,
                                weights: weights.length
                            });
                        } else {
                            console.log(`‚ö†Ô∏è Action ${i} does not exist or returned empty array`);
                        }
                    }
                } else {
                    console.log('üìã No actions found in contract');
                }

                console.log('üéâ React-like proposal loading test completed!');

            } catch (error) {
                console.error('‚ùå React-like proposal loading test failed:', error);
            }
        };

        // COMPREHENSIVE PROPOSAL DEBUG TEST
        window.debugProposals = async function() {
            console.log('üîç COMPREHENSIVE PROPOSAL DEBUG TEST');
            console.log('=====================================');

            try {
                const contractManager = await window.adminPage.ensureContractReady();

                // Step 1: Test basic contract connectivity
                console.log('üîß Step 1: Testing basic contract connectivity...');
                console.log('   - Contract address:', contractManager.stakingContract.address);
                console.log('   - Provider:', contractManager.provider.connection?.url || 'Unknown');
                console.log('   - Signer:', contractManager.signer ? 'Connected' : 'Not connected');

                // Step 2: Test action counter with detailed debugging
                console.log('üîß Step 2: Testing action counter...');
                try {
                    const actionCounterRaw = await contractManager.stakingContract.actionCounter();
                    const actionCounterNum = actionCounterRaw.toNumber();
                    console.log('   ‚úÖ Raw action counter:', actionCounterRaw);
                    console.log('   ‚úÖ Action counter number:', actionCounterNum);

                    if (actionCounterNum === 0) {
                        console.log('   ‚ö†Ô∏è ACTION COUNTER IS 0 - NO PROPOSALS EXIST IN CONTRACT!');
                        console.log('   üí° This means no proposals have been created yet.');
                        return;
                    }
                } catch (error) {
                    console.error('   ‚ùå Failed to get action counter:', error);
                    return;
                }

                // Step 3: Test individual action loading
                console.log('üîß Step 3: Testing individual action loading...');
                const actionCounter = await contractManager.getActionCounter();

                for (let i = 1; i <= Math.min(actionCounter, 10); i++) {
                    console.log(`   üîç Testing action ${i}:`);

                    try {
                        // Test actions() function
                        const actionRaw = await contractManager.stakingContract.actions(BigInt(i));
                        console.log(`     ‚úÖ Raw action ${i}:`, actionRaw);

                        // Test getActions() wrapper
                        const actionWrapped = await contractManager.getActions(i);
                        console.log(`     ‚úÖ Wrapped action ${i}:`, actionWrapped);

                        // Test action pairs
                        try {
                            const pairs = await contractManager.getActionPairs(i);
                            console.log(`     ‚úÖ Action ${i} pairs:`, pairs);
                        } catch (pairError) {
                            console.log(`     ‚ö†Ô∏è Action ${i} pairs failed:`, pairError.message);
                        }

                        // Test action weights
                        try {
                            const weights = await contractManager.getActionWeights(i);
                            console.log(`     ‚úÖ Action ${i} weights:`, weights);
                        } catch (weightError) {
                            console.log(`     ‚ö†Ô∏è Action ${i} weights failed:`, weightError.message);
                        }

                    } catch (error) {
                        console.log(`     ‚ùå Action ${i} failed:`, error.message);
                        console.log(`     üîç Error details:`, {
                            code: error.code,
                            data: error.data,
                            reason: error.reason
                        });
                    }
                }

                // Step 4: Test contract ABI functions
                console.log('üîß Step 4: Testing contract ABI functions...');
                const contractFunctions = Object.keys(contractManager.stakingContract.functions);
                console.log('   üìã Available contract functions:', contractFunctions.length);

                const actionRelatedFunctions = contractFunctions.filter(fn =>
                    fn.includes('action') || fn.includes('Action')
                );
                console.log('   üìã Action-related functions:', actionRelatedFunctions);

                // Step 5: Test proposal loading logic
                console.log('üîß Step 5: Testing proposal loading logic...');
                try {
                    const proposals = await window.adminPage.loadProposals();
                    console.log('   ‚úÖ Loaded proposals:', proposals.length);
                    console.log('   üìã Proposal details:', proposals);
                } catch (error) {
                    console.error('   ‚ùå Proposal loading failed:', error);
                }

                // Step 6: Check if contract has governance functions
                console.log('üîß Step 6: Checking governance functions...');
                const governanceFunctions = [
                    'actions',
                    'getActionPairs',
                    'getActionWeights',
                    'actionCounter',
                    'REQUIRED_APPROVALS',
                    'approveAction',
                    'rejectAction'
                ];

                for (const funcName of governanceFunctions) {
                    const hasFunction = typeof contractManager.stakingContract[funcName] === 'function';
                    console.log(`   ${hasFunction ? '‚úÖ' : '‚ùå'} ${funcName}: ${hasFunction ? 'Available' : 'Missing'}`);
                }

                console.log('üéâ PROPOSAL DEBUG TEST COMPLETED!');

            } catch (error) {
                console.error('‚ùå Proposal debug test failed:', error);
            }
        };

        // Test the fixed proposal loading
        window.testFixedProposalLoading = async function() {
            console.log('üß™ TESTING FIXED PROPOSAL LOADING');
            console.log('==================================');

            try {
                const contractManager = await window.adminPage.ensureContractReady();

                // Test 1: Get action counter
                console.log('üîß Step 1: Getting action counter...');
                const actionCounter = await contractManager.getActionCounter();
                console.log('   ‚úÖ Action counter:', actionCounter);

                if (actionCounter === 0) {
                    console.log('   ‚ö†Ô∏è No proposals exist in contract');
                    return;
                }

                // Test 2: Test fixed getActions function
                console.log('üîß Step 2: Testing fixed getActions function...');
                for (let i = 1; i <= Math.min(actionCounter, 5); i++) {
                    console.log(`   üîç Testing action ${i}:`);

                    try {
                        const action = await contractManager.getActions(i);
                        console.log(`     ‚úÖ Action ${i} loaded:`, {
                            actionType: action?.actionType,
                            executed: action?.executed,
                            expired: action?.expired,
                            approvals: action?.approvals,
                            rejected: action?.rejected
                        });

                        if (action) {
                            console.log(`     üìã Full action ${i}:`, action);
                        }

                    } catch (error) {
                        console.log(`     ‚ùå Action ${i} failed:`, error.message);
                    }
                }

                // Test 3: Test proposal loading through AdminPage
                console.log('üîß Step 3: Testing AdminPage proposal loading...');
                try {
                    const proposals = await window.adminPage.loadProposals();
                    console.log('   ‚úÖ AdminPage loaded proposals:', proposals.length);

                    if (proposals.length > 0) {
                        console.log('   üìã First proposal:', proposals[0]);
                    }
                } catch (error) {
                    console.error('   ‚ùå AdminPage proposal loading failed:', error);
                }

                console.log('üéâ FIXED PROPOSAL LOADING TEST COMPLETED!');

            } catch (error) {
                console.error('‚ùå Fixed proposal loading test failed:', error);
            }
        };

        // Simple test to see what the contract actually returns
        window.testRawContractCall = async function() {
            console.log('üîç TESTING RAW CONTRACT CALLS');
            console.log('=============================');

            try {
                const contractManager = await window.adminPage.ensureContractReady();

                // Test 1: Direct contract call
                console.log('üîß Step 1: Direct contract call...');
                try {
                    const rawResult = await contractManager.stakingContract.actions(BigInt(1));
                    console.log('   ‚úÖ Raw result type:', typeof rawResult);
                    console.log('   ‚úÖ Raw result is array:', Array.isArray(rawResult));
                    console.log('   ‚úÖ Raw result length:', rawResult?.length);
                    console.log('   ‚úÖ Raw result:', rawResult);

                    // Test accessing by index
                    if (rawResult) {
                        console.log('   üîç Index access test:');
                        console.log('     - rawResult[0] (actionType):', rawResult[0]);
                        console.log('     - rawResult[11] (executed):', rawResult[11]);
                        console.log('     - rawResult[13] (approvals):', rawResult[13]);
                    }

                } catch (error) {
                    console.error('   ‚ùå Direct contract call failed:', error.message);
                }

                // Test 2: Through getActions wrapper
                console.log('üîß Step 2: Through getActions wrapper...');
                try {
                    const wrappedResult = await contractManager.getActions(1);
                    console.log('   ‚úÖ Wrapped result:', wrappedResult);
                } catch (error) {
                    console.error('   ‚ùå Wrapped call failed:', error.message);
                }

                // Test 3: Check if action exists
                console.log('üîß Step 3: Checking if action 1 exists...');
                try {
                    const actionCounter = await contractManager.stakingContract.actionCounter();
                    console.log('   ‚úÖ Action counter:', actionCounter.toString());

                    if (actionCounter.toNumber() >= 1) {
                        console.log('   ‚úÖ Action 1 should exist');
                    } else {
                        console.log('   ‚ö†Ô∏è Action 1 does not exist');
                    }
                } catch (error) {
                    console.error('   ‚ùå Action counter check failed:', error.message);
                }

                console.log('üéâ RAW CONTRACT CALL TEST COMPLETED!');

            } catch (error) {
                console.error('‚ùå Raw contract call test failed:', error);
            }
        };

        // Test the final fix
        window.testFinalFix = async function() {
            console.log('üéØ TESTING FINAL ABI FIX');
            console.log('========================');

            try {
                const contractManager = await window.adminPage.ensureContractReady();

                // Test 1: Direct contract call with correct ABI
                console.log('üîß Step 1: Testing corrected ABI...');
                try {
                    const rawResult = await contractManager.stakingContract.actions(BigInt(1));
                    console.log('   ‚úÖ Raw result SUCCESS:', rawResult);
                    console.log('   ‚úÖ Action type:', rawResult[0]);
                    console.log('   ‚úÖ Executed:', rawResult[9]);
                    console.log('   ‚úÖ Approvals:', rawResult[11]);
                } catch (error) {
                    console.error('   ‚ùå Direct call still failing:', error.message);
                }

                // Test 2: Through getActions wrapper
                console.log('üîß Step 2: Testing getActions wrapper...');
                try {
                    const action = await contractManager.getActions(1);
                    console.log('   ‚úÖ Wrapped result SUCCESS:', action);
                } catch (error) {
                    console.error('   ‚ùå Wrapped call failed:', error.message);
                }

                // Test 3: Load all proposals
                console.log('üîß Step 3: Loading all proposals...');
                try {
                    const actionCounter = await contractManager.getActionCounter();
                    console.log(`   üìä Testing all ${actionCounter} actions...`);

                    for (let i = 1; i <= actionCounter; i++) {
                        try {
                            const action = await contractManager.getActions(i);
                            if (action) {
                                console.log(`   ‚úÖ Action ${i}: Type=${action.actionType}, Executed=${action.executed}, Approvals=${action.approvals}`);
                            } else {
                                console.log(`   ‚ö†Ô∏è Action ${i}: null result`);
                            }
                        } catch (error) {
                            console.log(`   ‚ùå Action ${i}: ${error.message}`);
                        }
                    }
                } catch (error) {
                    console.error('   ‚ùå Proposal loading failed:', error.message);
                }

                console.log('üéâ FINAL FIX TEST COMPLETED!');

            } catch (error) {
                console.error('‚ùå Final fix test failed:', error);
            }
        };

        // Test transaction RPC failover
        window.testTransactionRpcFailover = async function() {
            console.log('üîÑ TESTING TRANSACTION RPC FAILOVER');
            console.log('===================================');

            try {
                const contractManager = await window.adminPage.ensureContractReady();

                // Test 1: Check current RPC
                console.log('üîß Step 1: Current RPC status...');
                console.log('   Current RPC index:', contractManager.currentRpcIndex);
                console.log('   Current RPC URL:', contractManager.getCurrentRpcUrl());

                // Test 2: Test signer connection
                console.log('üîß Step 2: Testing signer connection...');
                try {
                    await contractManager.ensureSigner();
                    const signerAddress = await contractManager.signer.getAddress();
                    console.log('   ‚úÖ Signer connected:', signerAddress);
                } catch (error) {
                    console.error('   ‚ùå Signer connection failed:', error.message);
                    return;
                }

                // Test 3: Test a simple transaction (hourly rate proposal)
                console.log('üîß Step 3: Testing transaction with RPC failover...');
                console.log('   üìù Attempting to create hourly rate proposal...');

                try {
                    const result = await contractManager.proposeSetHourlyRewardRate(100);
                    console.log('   ‚úÖ Transaction successful:', result.hash);
                    console.log('   üìä Gas used:', result.gasUsed?.toString());
                    console.log('   üîó Block number:', result.blockNumber);
                } catch (error) {
                    console.error('   ‚ùå Transaction failed:', error.message);
                    console.log('   üîç Error details:', error);

                    // Check if RPC switched during error
                    console.log('   üìä RPC index after error:', contractManager.currentRpcIndex);
                    console.log('   üìä RPC URL after error:', contractManager.getCurrentRpcUrl());
                }

                console.log('üéâ TRANSACTION RPC FAILOVER TEST COMPLETED!');

            } catch (error) {
                console.error('‚ùå Transaction RPC failover test failed:', error);
            }
        };

        // Test pair loading for modals
        window.testPairLoading = async function() {
            console.log('üîç TESTING PAIR LOADING FOR MODALS');
            console.log('==================================');

            try {
                const contractManager = await window.adminPage.ensureContractReady();

                // Test 1: Check contract methods
                console.log('üîß Step 1: Testing contract pair methods...');

                try {
                    const pairs1 = await contractManager.stakingContract.getPairs();
                    console.log('   ‚úÖ getPairs() result:', pairs1);
                } catch (error) {
                    console.log('   ‚ùå getPairs() failed:', error.message);
                }

                try {
                    const pairs2 = await contractManager.stakingContract.getActivePairs();
                    console.log('   ‚úÖ getActivePairs() result:', pairs2);
                } catch (error) {
                    console.log('   ‚ùå getActivePairs() failed:', error.message);
                }

                // Test 2: Check getAllPairsInfo method
                console.log('üîß Step 2: Testing getAllPairsInfo...');
                try {
                    const allPairs = await contractManager.getAllPairsInfo();
                    console.log('   ‚úÖ getAllPairsInfo() result:', allPairs);
                    console.log('   üìä Number of pairs found:', allPairs.length);

                    if (allPairs.length > 0) {
                        allPairs.forEach((pair, index) => {
                            console.log(`   üìã Pair ${index + 1}: ${pair.name} (${pair.address}) - Weight: ${pair.weight}`);
                        });
                    }
                } catch (error) {
                    console.error('   ‚ùå getAllPairsInfo() failed:', error);
                }

                // Test 3: Check approved proposals
                console.log('üîß Step 3: Checking approved Add Pair proposals...');
                try {
                    const actionCounter = await contractManager.getActionCounter();
                    console.log('   üìä Total actions:', actionCounter);

                    let approvedPairs = 0;
                    for (let i = actionCounter; i > Math.max(actionCounter - 10, 0); i--) {
                        try {
                            const action = await contractManager.getActions(i);
                            if (action && action.actionType === 2) { // Add Pair
                                console.log(`   üìã Action ${i}: ${action.executed ? '‚úÖ Executed' : '‚è≥ Pending'} - ${action.pairNameToAdd} (${action.pairToAdd})`);
                                if (action.executed && !action.rejected) {
                                    approvedPairs++;
                                }
                            }
                        } catch (error) {
                            // Skip failed actions
                        }
                    }
                    console.log(`   üìä Approved pairs found: ${approvedPairs}`);
                } catch (error) {
                    console.error('   ‚ùå Failed to check proposals:', error);
                }

                console.log('üéâ PAIR LOADING TEST COMPLETED!');

            } catch (error) {
                console.error('‚ùå Pair loading test failed:', error);
            }
        };

        // Test the fixed pair loading
        window.testFixedPairLoading = async function() {
            console.log('üîß TESTING FIXED PAIR LOADING');
            console.log('=============================');

            try {
                const contractManager = await window.adminPage.ensureContractReady();

                // Test the fixed getAllPairsInfo method
                console.log('üîß Testing fixed getAllPairsInfo...');
                const allPairs = await contractManager.getAllPairsInfo();
                console.log('   ‚úÖ Fixed getAllPairsInfo() result:', allPairs);
                console.log('   üìä Number of pairs found:', allPairs.length);

                if (allPairs.length > 0) {
                    allPairs.forEach((pair, index) => {
                        console.log(`   üìã Pair ${index + 1}:`);
                        console.log(`      Name: ${pair.name}`);
                        console.log(`      Address: ${pair.address}`);
                        console.log(`      Platform: ${pair.platform}`);
                        console.log(`      Weight: ${pair.weight}`);
                        console.log(`      Active: ${pair.isActive}`);
                    });

                    // Test modal loading
                    console.log('üîß Testing modal pair loading...');

                    // Test remove pair modal
                    console.log('   üìã Testing loadPairsForRemoval...');
                    await window.adminPage.loadPairsForRemoval();

                    // Test weight update modal
                    console.log('   üìã Testing loadPairsForWeightUpdate...');
                    await window.adminPage.loadPairsForWeightUpdate();

                    console.log('   ‚úÖ Modal loading tests completed');
                } else {
                    console.log('   ‚ö†Ô∏è No pairs found - modals will show "No pairs available"');
                }

                console.log('üéâ FIXED PAIR LOADING TEST COMPLETED!');

            } catch (error) {
                console.error('‚ùå Fixed pair loading test failed:', error);
            }
        };

        // Test modal functionality
        window.testModalFunctionality = async function() {
            console.log('üîß TESTING MODAL FUNCTIONALITY');
            console.log('==============================');

            try {
                // Test 1: Check if modals open and show buttons
                console.log('üîß Step 1: Testing modal button visibility...');

                const modalTypes = [
                    { name: 'Change Signer', action: 'change-signer' },
                    { name: 'Remove Pair', action: 'remove-pair' },
                    { name: 'Update Pair Weights', action: 'update-weights' }
                ];

                for (const modal of modalTypes) {
                    console.log(`   üìã Testing ${modal.name} modal...`);

                    // Find and click the button
                    const button = document.querySelector(`[data-action="${modal.action}"]`);
                    if (button) {
                        button.click();

                        // Wait for modal to open
                        await new Promise(resolve => setTimeout(resolve, 500));

                        // Check modal elements
                        const modalContainer = document.getElementById('modal-container');
                        const modalFooter = modalContainer?.querySelector('.modal-footer');
                        const buttons = modalContainer?.querySelectorAll('.modal-footer button');

                        console.log(`     - Modal container: ${modalContainer ? '‚úÖ Found' : '‚ùå Not found'}`);
                        console.log(`     - Modal footer: ${modalFooter ? '‚úÖ Found' : '‚ùå Not found'}`);
                        console.log(`     - Footer buttons: ${buttons?.length || 0}`);

                        if (buttons && buttons.length > 0) {
                            buttons.forEach((btn, index) => {
                                console.log(`       Button ${index + 1}: "${btn.textContent.trim()}" (visible: ${btn.offsetWidth > 0 && btn.offsetHeight > 0})`);
                            });
                        }

                        // Close modal
                        const closeBtn = modalContainer?.querySelector('.modal-close');
                        if (closeBtn) {
                            closeBtn.click();
                            await new Promise(resolve => setTimeout(resolve, 200));
                        }
                    } else {
                        console.log(`     ‚ùå Button not found for ${modal.name}`);
                    }
                }

                console.log('üéâ MODAL FUNCTIONALITY TEST COMPLETED!');

            } catch (error) {
                console.error('‚ùå Modal functionality test failed:', error);
            }
        };

        // Test AdminPage loading
        window.testAdminPageLoading = function() {
            console.log('üîß TESTING ADMINPAGE LOADING');
            console.log('============================');

            console.log('üìã Checking class availability:');
            console.log('  - AdminPage:', typeof AdminPage !== 'undefined' ? '‚úÖ Available' : '‚ùå Missing');
            console.log('  - ContractManager:', typeof ContractManager !== 'undefined' ? '‚úÖ Available' : '‚ùå Missing');
            console.log('  - WalletManager:', typeof WalletManager !== 'undefined' ? '‚úÖ Available' : '‚ùå Missing');

            console.log('üìã Checking window objects:');
            console.log('  - window.AdminPage:', typeof window.AdminPage !== 'undefined' ? '‚úÖ Available' : '‚ùå Missing');
            console.log('  - window.adminPage:', typeof window.adminPage !== 'undefined' ? '‚úÖ Available' : '‚ùå Missing');

            if (typeof AdminPage !== 'undefined') {
                try {
                    console.log('üîß Testing AdminPage instantiation...');
                    const testInstance = new AdminPage();
                    console.log('‚úÖ AdminPage can be instantiated successfully');
                    console.log('üìã Instance properties:', {
                        isInitialized: testInstance.isInitialized,
                        isAuthorized: testInstance.isAuthorized,
                        DEVELOPMENT_MODE: testInstance.DEVELOPMENT_MODE
                    });
                } catch (error) {
                    console.error('‚ùå AdminPage instantiation failed:', error);
                }
            }

            console.log('üéâ ADMINPAGE LOADING TEST COMPLETED!');
        };

        // Test enhanced proposal display
        window.testEnhancedProposalDisplay = function() {
            console.log('üé® TESTING ENHANCED PROPOSAL DISPLAY');
            console.log('===================================');

            try {
                if (!window.adminPage) {
                    console.error('‚ùå AdminPage not available');
                    return;
                }

                console.log('üìã Checking proposal display enhancements:');

                // Check if proposals are loaded
                const proposalsTable = document.querySelector('#proposals-tbody');
                if (!proposalsTable) {
                    console.warn('‚ö†Ô∏è Proposals table not found');
                    return;
                }

                const proposalRows = proposalsTable.querySelectorAll('.proposal-row');
                console.log(`  - Found ${proposalRows.length} proposal rows`);

                proposalRows.forEach((row, index) => {
                    const proposalId = row.querySelector('.proposal-id')?.textContent;
                    const proposalSummary = row.querySelector('.proposal-summary')?.textContent;
                    const actionType = row.querySelector('.action-type')?.textContent;
                    const expandBtn = row.querySelector('.expand-btn');

                    console.log(`  üìã Proposal ${index + 1}:`);
                    console.log(`    - ID: ${proposalId}`);
                    console.log(`    - Type: ${actionType}`);
                    console.log(`    - Summary: ${proposalSummary}`);
                    console.log(`    - Expandable: ${expandBtn ? '‚úÖ Yes' : '‚ùå No'}`);

                    // Check if details row exists
                    const detailsRowId = proposalId ? `details-${proposalId.replace('#', '')}` : null;
                    const detailsRow = detailsRowId ? document.getElementById(detailsRowId) : null;
                    console.log(`    - Details row: ${detailsRow ? '‚úÖ Found' : '‚ùå Missing'}`);
                });

                // Test expand functionality
                const firstExpandBtn = document.querySelector('.expand-btn');
                if (firstExpandBtn) {
                    console.log('üîß Testing expand functionality...');
                    firstExpandBtn.click();

                    setTimeout(() => {
                        const expandedDetails = document.querySelector('.proposal-details-row[style*="table-row"]');
                        console.log(`  - Expansion works: ${expandedDetails ? '‚úÖ Yes' : '‚ùå No'}`);

                        if (expandedDetails) {
                            const parameterCards = expandedDetails.querySelectorAll('.parameter-card');
                            console.log(`  - Parameter cards: ${parameterCards.length}`);

                            parameterCards.forEach((card, cardIndex) => {
                                const label = card.querySelector('.parameter-label')?.textContent;
                                const value = card.querySelector('.parameter-value')?.textContent;
                                console.log(`    Card ${cardIndex + 1}: ${label} = ${value}`);
                            });
                        }

                        console.log('üéâ ENHANCED PROPOSAL DISPLAY TEST COMPLETED!');
                    }, 500);
                } else {
                    console.log('üéâ ENHANCED PROPOSAL DISPLAY TEST COMPLETED!');
                }

            } catch (error) {
                console.error('‚ùå Enhanced proposal display test failed:', error);
            }
        };

        // Quick test to verify mock proposals have enhanced data
        window.testMockProposalData = function() {
            console.log('üîç TESTING MOCK PROPOSAL DATA');
            console.log('============================');

            if (!window.adminPage) {
                console.error('‚ùå AdminPage not available');
                return;
            }

            // Get mock proposals
            const mockProposals = window.adminPage.getMockProposals();
            console.log(`üìã Found ${mockProposals.length} mock proposals`);

            mockProposals.forEach((proposal, index) => {
                console.log(`\nüìã Mock Proposal ${index + 1}:`);
                console.log(`  - ID: ${proposal.id}`);
                console.log(`  - Type: ${proposal.type}`);
                console.log(`  - Title: ${proposal.title}`);
                console.log(`  - Data:`, proposal.data);
            });

            // Test formatted proposals
            console.log('\nüîÑ Testing formatted proposals...');
            window.adminPage.loadMockProposals().then(formattedProposals => {
                console.log(`üìã Found ${formattedProposals.length} formatted proposals`);

                formattedProposals.forEach((proposal, index) => {
                    console.log(`\nüìã Formatted Proposal ${index + 1}:`);
                    console.log(`  - ID: ${proposal.id}`);
                    console.log(`  - Action Type: ${proposal.actionType}`);
                    console.log(`  - Enhanced Data:`);

                    // Show enhanced data fields
                    const enhancedFields = ['pairToAdd', 'pairNameToAdd', 'platformToAdd', 'weightToAdd',
                                          'newHourlyRewardRate', 'pairToRemove', 'recipient', 'withdrawAmount'];
                    enhancedFields.forEach(field => {
                        if (proposal[field] !== undefined) {
                            console.log(`    - ${field}: ${proposal[field]}`);
                        }
                    });

                    // Test summary generation
                    const summary = window.adminPage.getProposalSummary(proposal);
                    console.log(`  - Generated Summary: "${summary}"`);
                });

                console.log('üéâ MOCK PROPOSAL DATA TEST COMPLETED!');
            });
        };

        // Force refresh proposals to see enhanced display
        window.forceRefreshProposals = function() {
            console.log('üîÑ FORCING PROPOSAL REFRESH');
            console.log('===========================');

            if (!window.adminPage) {
                console.error('‚ùå AdminPage not available');
                return;
            }

            console.log('üîÑ Refreshing proposals...');
            window.adminPage.loadProposals().then(proposals => {
                console.log(`üìã Loaded ${proposals.length} proposals`);

                proposals.forEach((proposal, index) => {
                    console.log(`\nüìã Proposal ${index + 1}:`);
                    console.log(`  - ID: ${proposal.id}`);
                    console.log(`  - Action Type: ${proposal.actionType}`);
                    console.log(`  - Summary: ${window.adminPage.getProposalSummary(proposal)}`);

                    // Show enhanced data
                    const enhancedFields = ['pairToAdd', 'pairNameToAdd', 'platformToAdd', 'weightToAdd',
                                          'newHourlyRewardRate', 'pairToRemove', 'recipient', 'withdrawAmount'];
                    enhancedFields.forEach(field => {
                        if (proposal[field] !== undefined) {
                            console.log(`  - ${field}: ${proposal[field]}`);
                        }
                    });
                });

                // Refresh the UI
                console.log('üîÑ Refreshing UI...');
                window.adminPage.loadMultiSignPanel();

                console.log('üéâ FORCE REFRESH COMPLETED!');
            }).catch(error => {
                console.error('‚ùå Force refresh failed:', error);
            });
        };

        // Force use mock proposals (bypass all contract calls)
        window.forceMockProposals = function() {
            console.log('üé≠ FORCING MOCK PROPOSALS');
            console.log('========================');

            if (!window.adminPage) {
                console.error('‚ùå AdminPage not available');
                return;
            }

            console.log('üé≠ Loading enhanced mock proposals directly...');
            window.adminPage.loadMockProposals().then(proposals => {
                console.log(`üìã Loaded ${proposals.length} mock proposals`);

                proposals.forEach((proposal, index) => {
                    console.log(`\nüìã Mock Proposal ${index + 1}:`);
                    console.log(`  - ID: ${proposal.id}`);
                    console.log(`  - Action Type: ${proposal.actionType}`);
                    console.log(`  - Summary: ${window.adminPage.getProposalSummary(proposal)}`);

                    // Show enhanced data
                    const enhancedFields = ['pairToAdd', 'pairNameToAdd', 'platformToAdd', 'weightToAdd',
                                          'newHourlyRewardRate', 'pairToRemove', 'recipient', 'withdrawAmount'];
                    enhancedFields.forEach(field => {
                        if (proposal[field] !== undefined) {
                            console.log(`  - ${field}: ${proposal[field]}`);
                        }
                    });
                });

                // Force update the UI with mock proposals
                console.log('üîÑ Updating UI with mock proposals...');
                const proposalsHtml = window.adminPage.renderProposalsRows(proposals);
                const tbody = document.getElementById('proposals-tbody');
                if (tbody) {
                    tbody.innerHTML = proposalsHtml;
                    console.log('‚úÖ UI updated with enhanced mock proposals');
                } else {
                    console.warn('‚ö†Ô∏è Could not find proposals tbody');
                }

                console.log('üéâ FORCE MOCK PROPOSALS COMPLETED!');
            }).catch(error => {
                console.error('‚ùå Force mock proposals failed:', error);
            });
        };

        // Test all the fixes comprehensively
        window.testAllFixes = async function() {
            console.log('üß™ Testing all fixes comprehensively...');

            try {
                // Test 1: RPC failover system
                console.log('üîß Test 1: RPC failover system...');
                await testRpcFailover();

                // Test 2: Proposal debugging
                console.log('üîß Test 2: Proposal debugging...');
                await debugProposals();

                // Test 3: Contract manager functions
                console.log('üîß Test 3: Contract manager functions...');
                await testReactLikeProposalLoading();

                // Test 4: Proposal loading
                console.log('üîß Test 4: Proposal loading...');
                const proposals = await window.adminPage.loadProposals();
                console.log('‚úÖ Loaded proposals:', proposals.length);

                // Test 5: Contract information loading
                console.log('üîß Test 5: Contract information loading...');
                await window.adminPage.loadContractInformation();
                console.log('‚úÖ Contract information loaded');

                // Test 6: Error handling
                console.log('üîß Test 6: Error handling...');
                await testVotingWithErrorHandling();

                console.log('üéâ All fixes tested successfully!');

            } catch (error) {
                console.error('‚ùå Comprehensive test failed:', error);
            }
        };

        // Test RPC failover system
        window.testRpcFailover = async function() {
            console.log('üß™ Testing RPC failover system...');

            try {
                const contractManager = await window.adminPage.ensureContractReady();

                // Test 1: Check current RPC configuration
                console.log('üìä Current RPC configuration:');
                console.log('   - Current RPC Index:', contractManager.currentRpcIndex || 0);
                console.log('   - Available RPCs:', contractManager.rpcUrls?.length || 'N/A');
                console.log('   - Fallback RPCs:', contractManager.config?.fallbackRPCs?.length || 'N/A');
                console.log('   - RPC URLs:', contractManager.rpcUrls || contractManager.config?.fallbackRPCs || 'N/A');

                // Test 2: Test safe contract calls with specific error handling
                console.log('üîß Testing safe contract calls...');

                const actionCounter = await contractManager.safeContractCall(
                    () => contractManager.stakingContract.actionCounter(),
                    0,
                    'actionCounter'
                );
                console.log('‚úÖ Safe actionCounter call:', actionCounter);

                const requiredApprovals = await contractManager.safeContractCall(
                    () => contractManager.stakingContract.REQUIRED_APPROVALS(),
                    3,
                    'REQUIRED_APPROVALS'
                );
                console.log('‚úÖ Safe REQUIRED_APPROVALS call:', requiredApprovals);

                // Test 3: Test RPC health check
                console.log('üîß Testing RPC health check...');
                const isRpcDown = await window.adminPage.checkRpcHealth(contractManager);
                console.log('‚úÖ RPC health check result:', isRpcDown ? '‚ùå RPC Down' : '‚úÖ RPC Healthy');

                // Test 4: Test RPC switching capability
                console.log('üîß Testing RPC switching capability...');
                if (contractManager.switchToNextProvider) {
                    try {
                        const originalIndex = contractManager.currentProviderIndex || 0;
                        await contractManager.switchToNextProvider();
                        const newIndex = contractManager.currentProviderIndex || 0;
                        console.log('‚úÖ RPC switch test:', `${originalIndex} ‚Üí ${newIndex}`);
                    } catch (error) {
                        console.log('‚ö†Ô∏è RPC switch test failed:', error.message);
                    }
                } else {
                    console.log('‚ö†Ô∏è switchToNextProvider method not available');
                }

                // Test 5: Test error code detection
                console.log('üîß Testing error code detection...');
                const testErrors = [
                    { code: -32603, message: 'Internal JSON-RPC error' },
                    { message: 'missing trie node' },
                    { message: 'missing revert data' },
                    { code: 'NETWORK_ERROR' },
                    { message: 'could not detect network' }
                ];

                testErrors.forEach(error => {
                    const isRpcError = error.code === -32603 ||
                                     error.code === 'NETWORK_ERROR' ||
                                     error.message.includes('missing trie node') ||
                                     error.message.includes('Internal JSON-RPC error') ||
                                     error.message.includes('missing revert data') ||
                                     error.message.includes('could not detect network');
                    console.log(`   - ${JSON.stringify(error)}: ${isRpcError ? '‚úÖ Will trigger RPC switch' : '‚ùå Regular error'}`);
                });

                console.log('üéâ RPC failover system test completed!');

            } catch (error) {
                console.error('‚ùå RPC failover test failed:', error);
            }
        };

        // Test contract deployment and state
        window.testContractState = async function() {
            console.log('üîç TESTING CONTRACT STATE AND DEPLOYMENT');
            console.log('========================================');

            try {
                const contractManager = await window.adminPage.ensureContractReady();

                // Test 1: Basic contract info
                console.log('üîß Step 1: Basic contract information...');
                console.log('   - Contract Address:', contractManager.stakingContract.address);
                console.log('   - Provider URL:', contractManager.provider.connection?.url);

                // Test 2: Check if contract exists at address
                console.log('üîß Step 2: Checking contract existence...');
                try {
                    const code = await contractManager.provider.getCode(contractManager.stakingContract.address);
                    console.log('   - Contract code length:', code.length);
                    console.log('   - Contract exists:', code !== '0x');

                    if (code === '0x') {
                        console.log('   ‚ùå NO CONTRACT DEPLOYED AT THIS ADDRESS!');
                        return;
                    }
                } catch (error) {
                    console.error('   ‚ùå Failed to check contract code:', error);
                }

                // Test 3: Test basic contract functions
                console.log('üîß Step 3: Testing basic contract functions...');

                try {
                    const rewardToken = await contractManager.stakingContract.rewardToken();
                    console.log('   ‚úÖ Reward token:', rewardToken);
                } catch (error) {
                    console.log('   ‚ùå rewardToken() failed:', error.message);
                }

                try {
                    const hourlyRate = await contractManager.stakingContract.hourlyRewardRate();
                    console.log('   ‚úÖ Hourly rate:', hourlyRate.toString());
                } catch (error) {
                    console.log('   ‚ùå hourlyRewardRate() failed:', error.message);
                }

                // Test 4: Test governance-specific functions
                console.log('üîß Step 4: Testing governance functions...');

                try {
                    const actionCounter = await contractManager.stakingContract.actionCounter();
                    console.log('   ‚úÖ Action counter (raw):', actionCounter);
                    console.log('   ‚úÖ Action counter (number):', actionCounter.toNumber());

                    if (actionCounter.toNumber() === 0) {
                        console.log('   üí° DIAGNOSIS: Contract has 0 proposals - this is why nothing loads!');
                        console.log('   üí° SOLUTION: Create some test proposals first.');
                    }
                } catch (error) {
                    console.log('   ‚ùå actionCounter() failed:', error.message);
                    console.log('   üí° DIAGNOSIS: Contract may not have governance functions!');
                }

                try {
                    const requiredApprovals = await contractManager.stakingContract.REQUIRED_APPROVALS();
                    console.log('   ‚úÖ Required approvals:', requiredApprovals.toString());
                } catch (error) {
                    console.log('   ‚ùå REQUIRED_APPROVALS() failed:', error.message);
                }

                // Test 5: Check if we can create a proposal
                console.log('üîß Step 5: Testing proposal creation capability...');

                if (contractManager.signer) {
                    try {
                        // Test if we have admin role
                        const signerAddress = await contractManager.signer.getAddress();
                        console.log('   - Signer address:', signerAddress);

                        const hasAdmin = await contractManager.hasAdminRole(signerAddress);
                        console.log('   - Has admin role:', hasAdmin);

                        if (!hasAdmin) {
                            console.log('   üí° DIAGNOSIS: Current signer is not an admin - cannot create proposals');
                        }

                    } catch (error) {
                        console.log('   ‚ùå Admin role check failed:', error.message);
                    }
                } else {
                    console.log('   ‚ö†Ô∏è No signer connected - cannot test proposal creation');
                }

                // Test 6: Check contract version/deployment
                console.log('üîß Step 6: Contract deployment verification...');

                try {
                    // Try to get contract creation block
                    const currentBlock = await contractManager.provider.getBlockNumber();
                    console.log('   - Current block:', currentBlock);

                    // Check recent transactions to this contract
                    const filter = {
                        address: contractManager.stakingContract.address,
                        fromBlock: Math.max(0, currentBlock - 1000),
                        toBlock: 'latest'
                    };

                    const logs = await contractManager.provider.getLogs(filter);
                    console.log('   - Recent contract interactions:', logs.length);

                    if (logs.length === 0) {
                        console.log('   üí° DIAGNOSIS: No recent contract activity - contract may be newly deployed or unused');
                    }

                } catch (error) {
                    console.log('   ‚ùå Contract activity check failed:', error.message);
                }

                console.log('üéâ CONTRACT STATE TEST COMPLETED!');

            } catch (error) {
                console.error('‚ùå Contract state test failed:', error);
            }
        };

        // Emergency modal test function
        window.testEmergencyModal = function() {
            console.log('üß™ EMERGENCY: Testing modal system...');

            const modalContainer = document.getElementById('modal-container');
            if (!modalContainer) {
                console.error('‚ùå EMERGENCY: Modal container not found!');
                alert('‚ùå Modal container not found!');
                return;
            }

            console.log('‚úÖ EMERGENCY: Modal container found');

            modalContainer.innerHTML = `
                <div style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 255, 0, 0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 99999;
                " onclick="document.getElementById('modal-container').style.display='none'; document.getElementById('modal-container').innerHTML='';">
                    <div style="
                        background: white;
                        padding: 30px;
                        border-radius: 10px;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                        max-width: 500px;
                        width: 90%;
                        text-align: center;
                        color: black;
                        font-family: Arial, sans-serif;
                    " onclick="event.stopPropagation();">
                        <h2 style="color: #28a745; margin-bottom: 20px;">üß™ EMERGENCY MODAL TEST</h2>
                        <p style="margin-bottom: 20px;">If you can see this modal, the modal system is working!</p>
                        <p style="margin-bottom: 20px; color: #666;">This means the issue is with the admin modal HTML or CSS.</p>
                        <button onclick="document.getElementById('modal-container').style.display='none'; document.getElementById('modal-container').innerHTML='';"
                                style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            Close Test Modal
                        </button>
                    </div>
                </div>
            `;

            modalContainer.style.display = 'flex';
            console.log('‚úÖ EMERGENCY: Test modal displayed');
        };

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (adminPage) {
                adminPage.destroy();
            }
        });
    </script>

    <style>
        /* Loading styles for initial state */
        .admin-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #ffffff;
        }

        .loading-container {
            text-align: center;
            padding: 40px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #00d4ff;
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto 20px;
        }

        .loading-container h2 {
            margin: 0 0 10px 0;
            font-size: 24px;
            font-weight: 600;
            color: #ffffff;
        }

        .loading-container p {
            margin: 0;
            color: #a0a0a0;
            font-size: 16px;
        }

        .error-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #ffffff;
            text-align: center;
            padding: 40px;
        }

        .error-container h2 {
            margin: 0 0 15px 0;
            color: #ff6b6b;
            font-size: 24px;
        }

        .error-container p {
            margin: 0 0 25px 0;
            color: #a0a0a0;
            max-width: 500px;
            line-height: 1.6;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #error-boundary {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
        }
    </style>
</body>
</html>
